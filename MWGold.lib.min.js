function printAnalForUser(e,t){if(log("entry"),analysisHash||(analysisHash=loadVal("analysisHash",{})),analysisHash.Users&&analysisHash.Users[t]&&analysisHash.Users[t].Posts){log("passed checks"),$("#analResults").length?$("#analResults").html("<legend>New results</legend>"):$(e).append("<fieldset id='analResults'><legend>Results</legend></fieldset>"),$("#analResults").append("<b>Misc:</b></br><ul id='analList1'></ul>"),log("constructed fieldset");for(var a in analysisHash.Users[t])"Posts"!=a&&"MW"!=a&&($("#analList1").append('<li><span class="shade">'+a+":</span> "+analysisHash.Users[t][a]+"</li>"),log("pasted: "+a+": "+analysisHash.Users[t][a]));$("#analResults").append("<b>MW's stuff:</b></br><ul id='analList2'></ul>");for(var a in analysisHash.Users[t].MW)$("#analList2").append('<li><span class="shade">'+a+":</span> "+analysisHash.Users[t].MW[a]+"</li>"),log("pasted MW: "+a+": "+analysisHash.Users[t].MW[a]);$("#analResults").append("<b>Posts by Forum:</b></br><ul id='analList3'></ul>");for(var a in analysisHash.Users[t].Posts)$("#analList3").append('<li><span class="shade"><a href="'+knownURLS.showThreadURL+"?t="+a+'">Forum '+a+"</a>:</span> "+analysisHash.Users[t].Posts[a].length+"posts, most recent: "+analysisHash.Users[t].Posts[a][0]+"</li>"),log("pasted Posts: "+a+": "+analysisHash.Users[t].Posts[a].length)}}function analysePost(e){if(e.includes("[img")){imageHash||(imageHash=loadVal("imageHash",{}));var t=e.split("[img").slice(1);for(var a in t){var i=t[a].split("[/img")[0].replace(/^[^\]]*\]/,"");if(imageHash[i]?imageHash[i].count+=1:imageHash[i]={count:1},t[a].startsWith("2")){var n=t[a].split("]")[0].replace(/2=/,"");imageHash[i].size=n}}saveVal("imageHash",imageHash)}}function analyseUser(e){analysisHash||(analysisHash=loadVal("analysisHash",{})),analysisHash.Users||(analysisHash.Users={}),analysisHash.Users[e]||(analysisHash.Users[e]={}),analysisHash.Users[e].Posts||(analysisHash.Users[e].Posts={}),analysisHash.Users[e].totalPosts=0,$.get("https://www.myth-weavers.com/search.php?do=finduser&u="+e,function(e){var t=$(e).find("div.pagination > a:first").attr("href").split("=")[1].replace(/\D/g,"");log("(get 1): calling scrapeDatesNShit with searchID="+t+" and page=1"),t&&(scrapeDatesNShit(t,1),scrapeDatesNShit(t,2),scrapeDatesNShit(t,3))}),analysisHash.Users[e].MW||(analysisHash.Users[e].MW={}),$.get(memberURL+"?u="+e,function(t){$(t).find("fieldset.statistics_group > ul > li:has(span)").each(function(){var t=$(this).find("span").html().replace(/\:/,"").trim();analysisHash.Users[e].MW[t]="Last Activity"==t||"Current Activity"==t?$(this).find("span:last").html():$(this).html().split(">").slice(-1)[0].trim(),log('(get 2): storing analysisHash["Users"][userID]["MW"]['+t+"]="+analysisHash.Users[e].MW[t])}),saveVal("analysisHash",analysisHash)})}function scrapeDatesNShit(e,t){$.get("https://www.myth-weavers.com/search.php?searchid="+e+"&pp=200&page="+t,function(e){$(e).find("td.thead").each(function(){if($(this).html().includes("Go to Page..."))log("discarding this: "+$(this).html());else{var e=$(this).find("a").attr("href").split("=")[1],t=reorderDate($(this).html().split(">").slice(-1)[0].trim());log("forumID: "+e+" & date: "+t),analysisHash.Users[userID].Posts[e]?analysisHash.Users[userID].Posts[e].includes(t)||analysisHash.Users[userID].Posts[e].push(t):analysisHash.Users[userID].Posts[e]=[t]}}).promise().done(function(){var e=0;for(var t in analysisHash.Users[userID].Posts)e+=analysisHash.Users[userID].Posts[t].length;analysisHash.Users[userID].totalPosts?analysisHash.Users[userID].totalPosts+=e:analysisHash.Users[userID].totalPosts=e,saveVal("analysisHash",analysisHash),printAnalForUser(userID)})})}function analyseThread(){var e=getThreadID();e?$.get("https://www.myth-weavers.com/dt.php?t="+e,function(t){var a,i,n,o={},s=0,l=t.toString().split("\n");for(var r in l){var d=l[r];if(d.startsWith("Started at "))log("setting startDate to: "+reorderDate(d.replace(/^Started at /,"").split(" by ")[0])),"Invalid Date"==(a=new Date(reorderDate(d.replace(/^Started at /,"").split(" by ")[0]))).toString()&&debugMode&&log("Unable to parse thread's starting date");else if(d.startsWith("Author : ")){s++;var p=d.split(":")[1].trim();o[p]?o[p]++:(o[p]=1,log("adding unique Author: "+p))}else d.startsWith("Downloaded from Myth-Weavers (http")&&(log("setting endDate to: "+reorderDate((d=d.split(" at ")[1]).substr(0,d.length-2))),"Invalid Date"==(i=new Date(reorderDate(d.substr(0,d.length-2)))).toString()&&debugMode&&log("Unable to parse thread's scraping date"))}n=Math.abs(i.getTime()-a.getTime())/864e5;for(var h in o)o[h]={name:h,totalPosts:o[h],percentagePosts:parseFloat(o[h]/s*100).toFixed(2),postsPerDay:parseFloat(o[h]/n).toFixed(2),Thread:e};if(analysisHash||(analysisHash=loadVal("analysisHash",{})),analysisHash.Threads||(analysisHash.Threads={}),analysisHash.Threads[e]={authors:o,startDate:a,endDate:i,daysAlive:n},saveVal("analysisHash",analysisHash),printThreadAnalysis(e),$("#pmenucontent").length>0){$("#pmenucontent").html("");for(var c in o)o[c].name!=uName&&$("#pmenucontent").append("<div style='display:inline-block; background-color:#aaa; padding: 2px;'><input type='checkbox' "+(toggleHash["Private recipients checked by default"]?"checked":"")+" data-key='"+o[c].name+"'>"+o[c].name+"</input></div>")}}):log("Unable to determine threadID for thread")}function printThreadAnalysis(e){if(analysisHash||(analysisHash=loadVal("analysisHash",{})),analysisHash.Threads&&analysisHash.Threads[e]){$("#statContainer").remove();var t=new Date(analysisHash.Threads[e].endDate);$("#breadcrumb").parent().prepend("<div id='statContainer' style='background: url(https://static.myth-weavers.com/images/sonata/misc/buttonbarbg.jpg)'>Stats as of: "+t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate()+"<br/><ul id='stats'></ul></div>");for(var a in analysisHash.Threads[e].authors)$("#stats").append("<li>"+analysisHash.Threads[e].authors[a].name+": "+analysisHash.Threads[e].authors[a].totalPosts+"posts, "+analysisHash.Threads[e].authors[a].percentagePosts+"% of total posts and <b>"+analysisHash.Threads[e].authors[a].postsPerDay+"</b> posts per day.</li>")}}function reorderDate(e){var t=new Date,a=new Date;a.setDate(t.getDate()-1);var i=e.replace(/ '/,", 20").replace(/(p|a)m/,":00 GMT");if(i.replace(/Today/,t.getMonth()+1+" "+t.getDate()+", "+t.getFullYear()),i.replace(/Yesterday/,a.getMonth()+1+" "+a.getDate()+", "+t.getFullYear()),e.includes("pm")){var n=i.split(":"),o=parseInt(n[0].slice(n[0].length-2).trim());i=n[0].substr(0,n[0].length-2).trim()+" "+(12+o)+":"+n.slice(1).join(":")}return i}function isBuffed(e){var t=0,a=getBuffs(e);for(var i in a)t+=parseInt(a[i]);return log("returning "+t),t}function whichBuffs(e){var t=getBuffs(e);return t=={}?"":Object.keys(t).join(", ")}function getBuffs(e){var t={};if(Array.isArray(e))for(var a in e)$.extend(t,getBuffs(e[a]));else buffHash[e]&&(t=buffHash[e]);return log("returning "+JSON.stringify(t)),t}function buffsOn(e,t){for(var a in t)buffHash[a]||(buffHash[a]={}),buffHash[a][e]=t[a];log("buffHash: "+JSON.stringify(buffHash))}function buffsOff(e){for(var t in buffHash)buffHash[t][e]&&delete buffHash[t][e];log("removed "+e),log("buffHash: "+JSON.stringify(buffHash))}function clearBuffs(){var e=Object.keys(buffHash).length;buffHash={},log("cleared buffHash of "+e+" buffs")}function makeRollString(e,t){return"[roll="+e+"]"+t.replace(/\+\-/g,"-")+"z[/roll]"}function makeAttackRollString(e,t){if(!t)return"error: attached hash not an attack hash";var a=t.Type;a&&1==a.length&&(a={P:"Piercing",B:"Bludgeoning",S:"Slashing"}[a.toUpperCase()]);var i=e.replace(/(\+.*\b)/g,"").trim(),n=whichBuffs(["attack","damage"]),o="[roll="+i+" attack;"+(t.Special&&t.Special.length>0?t.Special.replace(/\[/g,"(").replace(/\]/g,")")+", ":"")+"crit:"+t.Crit+(n.length>0?" with "+n:"")+"]",s=t.AB.replace(/[a-z]/gi,"").split(/[\/,\s]+|\sor\s|\sand\s/);for(var l in s)o+=buffRoll("1d20"+s[l],"attack")+"z ";o=o.trim(),o+="[/roll] and [roll="+i+" damage"+(a?";"+a:"")+"]";for(var r in t.AB.split("/"))o+=buffRoll(t.Damage,"damage")+"z ";return o.trim()+"[/roll]"}function buffRoll(e,t){var a=isBuffed(t.toLowerCase());if(0==a)return e;var i=e;if(e.includes("+")){var n=e.replace(/[^+-\d]/g,"").split("+").slice(1);for(var o in n)if(a+=parseInt(n[o].split("-")[0]),n[o].includes("-")){l=n[o].split("-").slice(1);for(var s in l)a-=parseInt(l[s])}i=e.split("+")[0]}else if(e.includes("-")){var l=e.replace(/[^-\d]/g,"").split("-").slice(1);for(var s in l)a-=parseInt(l[s]);i=e.split("-")[0]}return i+(0==a?"":a>0?"+"+a:a)}function calculateDP(){log("this: "+this.id+" changed!");var e="",t="",a=0,i=4,n=0,o=[];if($("#pfWCA_simple").prop("checked")&&(e="simple"),$("#pfWCA_martial").prop("checked")&&(e="martial",i=5),$("#pfWCA_exotic").prop("checked")&&(e="exotic",i=6),$("#pfWC_OutputQuals").html(""),$("#pfWepCreator_aria input.pfWCA_bits:checked").add("#pfWepCreator_aria select option:selected").each(function(){$(this).val()&&(a+=parseInt($(this).val())),"pfWCA_ADP"==$(this).parent().attr("id")&&(i+=-15*parseInt($(this).val())),"pfWCA_Shield"==$(this).attr("id")&&(i+=3),"pfWCA_ShieldArmSpike"==$(this).attr("id")&&(i+=50),"pfWCA_Tool"==$(this).attr("id")&&(i+=150*parseInt($("#pfWCA_ToolNumTools").val()),n+=2*parseInt($("#pfWCA_ToolNumTools").val())),$(this).data("extra")&&o.push($(this).data("extra"));var e=$(this).text();""==e&&(e=$(this).parent().find("label[for="+$(this).attr("id")+"]").text()),"None"!=e&&"As above"!=e&&"Choose melee/ranged first"!=e&&"20"!=e&&"Not attached"!=e&&"x2"!=e&&"1d3"!=e&&""!=e&&$("#pfWC_OutputQuals").append(e+" ("+$(this).val()+"), "),$(this).attr("title",$(this).attr("id"))}),$("#tot").html(a),$("#pfWC_OutputHead").html($("#pfWC_WepName").val()),$("#pfWC_OutputDesc").html($("#pfWC_WepDesc").val()+(o.length>0?'<ol style="list-style-type: lower-roman"><li>'+o.join("</li><li>")+"</li></ol>":"")),$("#pfWCA_light").prop("checked")&&(t="light"),$("#pfWCA_one-handed").prop("checked")&&(t="one-handed"),$("#pfWCA_two-handed").prop("checked")&&(t="two-handed"),$("#pfWC_OutputStatBlock").html("<b>Price</b> "+i+" gp; <b>Type</b> "+t+" "+($("#pfWCA_melee").prop("checked")?"melee":"ranged")+"; <b>Proficiency</b> "+e+"; <b>Damage (M)</b> "+$("#pfWepDMG select option:selected").text()+"; <b>Critical</b> "+$("#pfWepCrit1 select option:selected").text()+"/"+$("#pfWepCrit2 select option:selected").text()+"; <b>Weapon Group</b> "+$("#pfWC_WepGroup").val()+"; <b>Weight</b> "+n+" lbs."),$("#pfWCA_Conc").checkboxradio($("#pfWCA_light").prop("checked")||$("#pfWCA_one-handed").prop("checked")?"enable":"disable"),$("#pfWCA_Ease").checkboxradio($("#pfWCA_exotic").prop("checked")&&$("#pfWCA_one-handed").prop("checked")?"enable":"disable"),$("#pfWCA_Fin").checkboxradio($("#pfWCA_exotic").prop("checked")||$("#pfWCA_one-handed").prop("checked")?"enable":"disable"),$("#pfWCA_Shield").checkboxradio($("#pfWCA_melee").prop("checked")&&$("#pfWCA_one-handed").prop("checked")?"enable":"disable"),$("#pfWCA_Trad").checkboxradio($("#pfWCA_exotic").prop("checked")?"enable":"disable"),$("#pfWCA_Spring-Loaded").checkboxradio(!$("#pfWCA_melee").prop("checked")||$("#pfWCA_light").prop("checked")||"reach"!=$("#pfWCA_WeapFeat1").val()&&"reach"!=$("#pfWCA_WeapFeat2").val()&&"reach"!=$("#pfWCA_WeapFeat3").val()?"disable":"enable"),$("#pfWCA_WeapFeat2").selectmenu($("#pfWCA_exotic").prop("checked")||$("#pfWCA_martial").prop("checked")?"enable":"disable"),$("#pfWCA_WeapFeat3").selectmenu($("#pfWCA_exotic").prop("checked")?"enable":"disable"),"pfWCA_ICTR"==$(this).attr("id")&&("20"==$(this).val()?$("#pfWCA_ImprovedMult").html("<option value='0' selected='selected'>x2</option><option value='3'>x3</option><option value='6'>x4</option>"):$("#pfWCA_ImprovedMult").html("<option value='0' selected='selected'>x2</option><option value='6'>x3</option>"),$("#pfWCA_ImprovedMult").selectmenu("refresh")),$("#pfWCA_ImpDamn option").prop("disabled",!0).each(function(){if($(this).prop("disabled",!1),$("#pfWCA_light").prop("checked")&&2==$(this).val()||$("#pfWCA_one-handed").prop("checked")&&(!$("#pfWCA_exotic").prop("checked")&&3==$(this).val()||$("#pfWCA_exotic").prop("checked")&&4==$(this).val())||$("#pfWCA_two-handed").prop("checked")&&5==$(this).val()||!$("#pfWCA_melee").prop("checked")&&($("#pfWCA_two-handed").prop("checked")&&4==$(this).val()||$("#pfWCA_one-handed").prop("checked")&&2==$(this).val()))return!1}),$("#pfWCA_ImpDamn").selectmenu("refresh"),"MPT"==$(this).attr("name")){if($("#pfWCA_ERI").html("<option value='0' selected='selected'>None</option>"),"pfWCA_melee"==$(this).attr("id")?($("#pfWCA_ERI").selectmenu("disable"),$("#pfWCA_light").checkboxradio("enable"),$("#pfWCA_Aero").checkboxradio("enable")):($("#pfWCA_ERI").selectmenu("enable"),$("#pfWCA_light").checkboxradio("disable"),$("#pfWCA_Aero").checkboxradio("disable")),"pfWCA_thrown"==$(this).attr("id"))for(s=1;s<3;s++)$("#pfWCA_ERI").append("<option value='"+s+"'>+"+s+"0ft/"+s+"DP</option>");else if("pfWCA_projectile"==$(this).attr("id"))for(var s=1;s<8;s++)$("#pfWCA_ERI").append("<option value='"+s+"'>+"+s+"0ft/"+s+"DP</option>");$("#pfWCA_ERI").selectmenu("refresh")}}function createWeaponCreatorDialog(){$("#pfWepCreator_aria").length>0?$("#pfWepCreator_aria").show():($('<div id="pfWepCreator_div"></div>').hide().dialog({minHeight:800,minWidth:800}).appendTo("head"),$(".ui-dialog[aria-describedBy=pfWepCreator_div]").attr("id","pfWepCreator_aria").css("min-width","700px").position({my:"top center",at:"bottom center",of:"#menu_bar"}).append('<table><tr id="pfWepTR1"></tr><tr id="pfWepTR2"></tr><tr id="pfWepTR3"></tr><tr id="pfWepTR4"></tr></table>'),$("#pfWepTR1").append('<td style="width:50%">Proficiency:<br><label for="pfWCA_simple">Simple (4 DP)</label><input type="radio" name="SME" value="-4" id="pfWCA_simple"><label for="pfWCA_martial">Martial (5 DP)</label><input type="radio" value="-5" name="SME" id="pfWCA_martial"><label for="pfWCA_exotic">exotic (6 DP)</label><input type="radio" value="-6" name="SME" id="pfWCA_exotic"></td>').append('<td style="width:50%"><br>Damage type: <label for="pfWCA_bludge">Bludgeoning</label><input type="radio" name="PBS" value="0" id="pfWCA_bludge"><label for="pfWCA_piercing">Piercing</label><input type="radio" value="0" name="PBS" id="pfWCA_piercing"><label for="pfWCA_slashing">Slashing</label><input type="radio" value="0" name="PBS" id="pfWCA_slashing"></td>'),$("#pfWepTR1 td:last").append("<br><label for='pfWCA_ADT'>Additional Damage Type (1 or 3 DP): </label><select name='ADT' id='pfWCA_ADT'><option value='0' selected='selected'>As above</option><option value='1'>Piercing or Bludgeoning</option><option value='1'>Piercing or Slashing</option><option value='1'>Slashing or Bludgeoning</option><option value='3'>Piercing and Bludgeoning</option><option value='3'>Piercing and Slashing</option><option value='3'>Slashing and Bludgeoning</option></select>"),$("#pfWepTR2").append('<td style="width:50%"><span title="A projectile ranged weapon has a 50-foot range increment and uses ammunition, while a thrown ranged weapon has a 10-foot range increment.">Range: <label for="pfWCA_melee">Melee</label><input type="radio" value="0" name="MPT" id="pfWCA_melee"><label for="pfWCA_thrown">Thrown (10ft)</label><input type="radio" value="0" name="MPT" id="pfWCA_thrown"><label for="pfWCA_projectile">Projectile (50ft)</label><input value="0" type="radio" name="MPT" id="pfWCA_projectile"></span></td>').append('<td style="width:50%"><span title="The base number of Design Points of one-handed and ranged weapons increases by 2, and the base number of Design Points of two-handed weapons increases by 3."><label for="pfWCA_light">Light (melee only)</label><input type="radio" value="0" name="L12" id="pfWCA_light"><label for="pfWCA_one-handed">One-handed</label><input type="radio" name="L12" value="-2" id="pfWCA_one-handed"><label for="pfWCA_two-handed">Two-handed</label><input type="radio" name="L12" value="-3" id="pfWCA_two-handed"></span></td>'),$("#pfWepTR3").append('<td style="width:50%">Base statistics: Damage (M) <span id="pfWepDMG">1d3</span><br>Critical <span id="pfWepCrit1">20</span>/<span id="pfWepCrit2">x2</span></td>').append('<td style="width:50%">Fighter Weapon Group: <input id="pfWC_WepGroup" type="textbox" name="FWG"></td>'),$("#pfWepCrit2").html("<select class='miniselect' title='Increase the weapon`s critical multiplier by 1. This quality can be selected twice. It costs 3 DP the first time it is selected, and 6 DP the second time. It can be selected only once if the weapon has the improved critical threat range quality, in which case the Design Point cost is doubled.' name='ImprovedMult' id='pfWCA_ImprovedMult'><option value='0' selected='selected'>x2</option><option value='3'>x3</option><option value='6'>x4</option></select>"),$("#pfWepCrit1").html("<select class='miniselect' name='ICTR' id='pfWCA_ICTR'><option value='0' selected='selected'>20</option><option value='3'>19-20</option><option value='7'>18-20</option></select>"),$("#pfWepDMG").html("<select class='miniselect' name='ImpDamn' id='pfWCA_ImpDamn'><option value='-1'>1d2</option><option value='0' selected='selected'>1d3</option><option value='1'>1d4</option><option value='2'>1d6</option><option value='3'>2d4 (or 1d8)</option><option value='4'>1d10</option><option value='5'>2d6 (or 1d12)</option></select>"),$("#pfWepTR4").append('<td style="width:50%"><h4>Melee</h4></td><td style="width:50%"><h4>Ranged</h4></td>'),$("#pfWepTR4 td:first").append("<label title='The weapon has a 10-foot range and can be thrown up to 5 range increments. Only melee weapons can have this quality.' for='pfWCA_Aero'>Aerodynamic (1 DP)</label><input type='checkbox' name='Aero' data-extra='The weapon has a 10-foot range and can be thrown up to 5 range increments.' value='1' id='pfWCA_Aero'>").append("<label title='The weapon can be used with Weapon Finesse as if it were a light weapon. Only one-handed and exotic melee weapons can have this quality.' for='pfWCA_Fin'>Finesse (3 DP)</label><input type='checkbox' value='3' name='Fin' id='pfWCA_Fin'>").append("<label title='The weapon counts as a light shield made of wood or metal and can have armor spikes (your choice). Add the gp price of the shield and any armor spikes that the weapon gains from this quality to the weapon`s gp price. This quality can be added only to one-handed melee weapons.' for='pfWCA_Shield'>Shield (1 DP)</label><input type='checkbox' value='1' name='Shield' id='pfWCA_Shield'> <label for='pfWCA_ShieldArmSpike'>+ Armour Spikes?</label><input type='checkbox' value='0' name='ShieldArmSpike' id='pfWCA_ShieldArmSpike'>").append("<label title='The weapon`s wielder can activate or suspend its reach as a swift action. This quality can be added only to one-handed or two-handed melee weapons with the reach special feature.' for='pfWCA_Spring-Loaded'>Spring-Loaded (2 DP)</label><input type='checkbox' value='2' data-extra='The wielder can activate or suspend its reach as a swift action.' name='Spring-Loaded' id='pfWCA_Spring-Loaded'>"),$("#pfWepTR4 td:last").append("<label for='pfWCA_ERI'>Expanded Range Increment (1 DP): </label><select name='ERI' id='pfWCA_ERI'><option value='0' selected='selected'>Choose melee/ranged first</option></select>"),$("#pfWepCreator_aria").append("<hr>").append("<label for='pfWCA_WeapFeat1'>Weapon Feature (1 DP)</label><select name='WeapFeat1' id='pfWCA_WeapFeat1'><option value='0' selected='selected'>None</option><option value='1'>blocking</option><option value='1'>brace</option><option value='1'>deadly</option><option value='1'>disarm</option><option value='1'>distracting</option><option value='1'>grapple</option><option value='1'>monk</option><option value='1'>nonlethal</option><option value='1'>performance</option><option value='1'>reach</option><option value='1'>trip</option></select>").append("<label for='pfWCA_WeapFeat2'>Weapon Feature (3 DP)</label><select name='WeapFeat2' id='pfWCA_WeapFeat2'><option value='0' selected='selected'>None</option><option value='3'>blocking</option><option value='3'>brace</option><option value='3'>deadly</option><option value='3'>disarm</option><option value='3'>distracting</option><option value='3'>grapple</option><option value='3'>monk</option><option value='3'>nonlethal</option><option value='3'>performance</option><option value='3'>reach</option><option value='3'>trip</option></select>").append("<br><label for='pfWCA_WeapFeat3'>Weapon Feature (4 DP)</label><select name='WeapFeat3' id='pfWCA_WeapFeat3'><option value='0' selected='selected'>None</option><option value='4'>blocking</option><option value='4'>brace</option><option value='4'>deadly</option><option value='4'>disarm</option><option value='4'>distracting</option><option value='4'>grapple</option><option value='4'>monk</option><option value='4'>nonlethal</option><option value='4'>performance</option><option value='4'>reach</option><option value='4'>trip</option></select>"),$("#pfWepCreator_aria").append('<table><tr><td>Name:</td><td><input id="pfWC_WepName" type="textbox" style="width:500px" value="Name of weapon"></td></tr><tr><td>Description:</td><td><input id="pfWC_WepDesc" type="textarea" style="height:200px;width:500px" value="Description of weapon"></td></tr></table>'),$("#pfWepCreator_aria").append("<h3>Buy offs</h3>").append("<label for='pfWCA_ADP'>Additional Design Points (-1 or -2 DP): </label><select name='ADP' id='pfWCA_ADP'><option value='0'>None</option><option value='-1'>+1 DP for 15gp</option><option value='-2' selected='selected'>+2 DP for 30gp</option></select>").append("<label title='The weapon gains the fragile special weapon feature.' for='pfWCA_Frag'>Fragile (-1 DP)</label><input type='checkbox' data-extra='Fragile (breaks on an attack roll of 1)' value='-1' name='Frag' id='pfWCA_Frag'>").append("<h3>Upgrades</h3>").append("<label title='The weapon can also serve as a specific mundane tool. Add triple the price and double the weight of the tool to the weapon`s final price and weight.' for='pfWCA_Tool'>Tool (0 DP): </label><input type='checkbox' value='0' name='Tool' id='pfWCA_Tool' data-extra='The weapon can also serve as a specific mundane tool.'><input type='textbox' id='pfWCA_ToolNumTools' style='width:20px' min='0' value='0'>").append("<select title='The weapon is attached to the wielder`s arm and cannot be disarmed. The wielder can wield or carry items in the hand to which this weapon is attached, but she takes a –2 penalty on all precision-based tasks involving that hand (such as opening locks). This penalty can be removed by increasing this quality`s cost to 3 DP.' name='Attached' id='pfWCA_Attached'><option value='0' selected='selected'>Not attached</option><option data-extra='cannot be disarmed</li><li>–2 penalty on all precision-based tasks involving that hand (such as opening locks)' value='1'>Attached, with -2 penalty on stuff (1DP)</option><option data-extra='cannot be disarmed' value='3'>Attached with no penalty (3DP)</option></select>").append("<br><label title='The weapon is easy to hide, granting the wielder a +2 bonus on Sleight of Hand checks to conceal it. Only light and one-handed melee weapons and ranged weapons that need one hand to fire can have this quality.' for='pfWCA_Conc'>Concealed (1 DP)</label><input data-extra='+2 bonus on Sleight of Hand checks to conceal it' type='checkbox' name='Conc' value='1' id='pfWCA_Conc'>").append("<label title='The weapon can be wielded as a two-handed martial weapon. Only one-handed exotic weapons can have this quality.' for='pfWCA_Ease'>Ease of Grip (1 DP)</label><input type='checkbox' name='Ease' value='1' id='pfWCA_Ease'>").append("<label title='The weapon`s wielder gains a +2 bonus to her Combat Maneuver Defense to resist sunder combat maneuvers attempted against the weapon.' for='pfWCA_Stronk'>Strong (1 DP)</label><input type='checkbox' value='1' name='Stronk' id='pfWCA_Stronk' data-extra='+2 bonus to her Combat Maneuver Defense to resist sunder combat maneuvers attempted against the weapon'>").append("<label title='Select one race with the weapon familiarity racial trait (such as elves or orcs). Members of that race with the weapon familiarity racial trait treat the weapon as a martial weapon. This quality can be applied only to exotic weapons.' for='pfWCA_Trad'>Traditional (1 DP)</label><input type='checkbox' value='1' name='Trad' id='pfWCA_Trad'>"),$("#pfWepCreator_aria > div:first > span:first").html("PF Weapon Creator<br>DP under/over limit: <span id='tot'>?</span>"),$("#pfWepCreator_aria > div:first").after("<div style='background-color:white' id='pfWC_Output'><h4 id='pfWC_OutputHead' style='background-color:rgb(207,226,243);padding:3px'></h4><p id='pfWC_OutputDesc' style='font:normal 10pt black Arial,sans-serif;background-color:white'></p><p style='font:normal 10pt black Arial,sans-serif;background-color:white' id='pfWC_OutputStatBlock'></p><p style='font-size:12px;font-weight:bold;border-top:thin solid;border-bottom:thin solid'>QUALITIES</p><p style='font:normal 10pt black Arial,sans-serif;background-color:white' id='pfWC_OutputQuals'></p></div>"),$("#pfWepCreator_aria [title]").css("text-decoration","underline"),$("#pfWepCreator_aria input:radio").checkboxradio({icon:!1}),$("#pfWepCreator_aria input:checkbox").checkboxradio({icon:!1}),$("#pfWepCreator_aria select").selectmenu(),$("#pfWepCreator_aria select.miniselect").selectmenu("option","width",100),$("#pfWepCreator_aria input").add("#pfWepCreator_aria input:checkbox").addClass("pfWCA_bits"),$("#pfWepCreator_aria").on("change",".pfWCA_bits",calculateDP),$("#pfWepCreator_aria select").on("selectmenuchange",calculateDP),calculateDP())}function createNPCGenDialog(){if($("#npcDialog").length>0)$("#npcDialog").dialog("open");else{$('<div id="npcDialog" title="NPC Generator"><p>Loading...</p></div>').dialog({width:590,position:{my:"center top",at:"center bottom",of:$("#menu_bar")[0]}}).appendTo("head"),fixCloseButtonOnDialog(),$("div.ui-dialog.ui-front[aria-describedBy=npcDialog]").addClass("smallfont").append('<form id="npggenpackage"><div class="col span-3"><span id="npcexplainbtn" class="button">Click to hide/show instructions</span><br/><div id="npcexplain" hidden style="font: 16px georgia; color: #333;">Welcome to the Dungeons &amp; Dragons 3.5 Random NPC Generator, originally developed by Jamis Buck, updated and maintained by Myth-Weavers. Check out our other generators from the Site Tools menu in the navigation!<br><br>This tool allows you to generate random characters for the heroes of your campaign to encounter.<p><i>Please note</i> that this generator will only generate NPCs of up to character level 20. If you try to create a Wiz20/Sor20/Clr20 character - that\'s actually a <i>60th level character</i>! If you input more than 20 levels, only the first 20 will be calculated.</p>  <p>The level input can be set to any <b>integer 1-20</b> or any of the following: <b>any, low, med, high.</b></p></div><br><table><tbody><tr><td align="right">Alignment: </td><td><select name="a"><option value="any" selected="">Any</option><option value="evil">Any evil</option><option value="good">Any good</option><option value="geneutral">Any Good/Evil/Neutral</option><option value="lcneutral">Any Lawful/Chaotic/Neutral</option><option value="lawful">Any Lawful</option><option value="chaotic">Any Chaotic</option><option value="ce">Chaotic Evil</option><option value="cg">Chaotic Good</option><option value="cn">Chaotic Neutral</option><option value="le">Lawful Evil</option><option value="lg">Lawful Good</option><option value="ln">Lawful Neutral</option><option value="ne">Neutral Evil</option><option value="ng">Neutral Good</option><option value="nn">Neutral</option></select></td><td align="right">Class #1: </td><td><select name="class1"><option value="any" selected="">Any</option><option value="anynpc">Any NPC</option><option value="anypc">Any PC</option><option value="barbarian">Barbarian</option><option value="bard">Bard</option><option value="cleric">Cleric</option><option value="druid">Druid</option><option value="fighter">Fighter</option><option value="monk">Monk</option><option value="paladin">Paladin</option><option value="ranger">Ranger</option><option value="rogue">Rogue</option><option value="sorcerer">Sorcerer</option><option value="wizard">Wizard</option><option value="adept">Adept</option><option value="aristocrat">Aristocrat</option><option value="commoner">Commoner</option><option value="expert">Expert</option><option value="warrior">Warrior</option></select></td><td align="right">Level #1: </td><td><input name="level1" maxlength="4" value="any" style="width: 36px;" type="text"></td></tr><tr><td align="right">Gender: </td><td><select name="g"><option value="any" selected="">Any</option><option value="female">Female</option><option value="male">Male</option></select></td><td align="right">Class #2: </td><td><select name="class2"><option value="any" selected="">Any</option><option value="anynpc">Any NPC</option><option value="anypc">Any PC</option><option value="barbarian">Barbarian</option><option value="bard">Bard</option><option value="cleric">Cleric</option><option value="druid">Druid</option><option value="fighter">Fighter</option><option value="monk">Monk</option><option value="paladin">Paladin</option><option value="ranger">Ranger</option><option value="rogue">Rogue</option><option value="sorcerer">Sorcerer</option><option value="wizard">Wizard</option><option value="adept">Adept</option><option value="aristocrat">Aristocrat</option><option value="commoner">Commoner</option><option value="expert">Expert</option><option value="warrior">Warrior</option></select></td><td align="right">Level #2: </td><td><input name="level2" maxlength="4" value="any" style="width: 36px;" type="text"></td></tr><tr><td align="right">Race: </td><td><select name="r"><option value="any" selected="">Any</option><option value="human">Human</option><option value="dwarf">Dwarf</option><option value="elf">Elf</option><option value="gnome">Gnome</option><option value="halfelf">Half Elf</option><option value="hafling">Halfling</option><option value="halforc">Half Orc</option></select></td><td align="right">Class #3: </td><td><select name="class3"><option value="any" selected="">Any</option><option value="anynpc">Any NPC</option><option value="anypc">Any PC</option><option value="barbarian">Barbarian</option><option value="bard">Bard</option><option value="cleric">Cleric</option><option value="druid">Druid</option><option value="fighter">Fighter</option><option value="monk">Monk</option><option value="paladin">Paladin</option><option value="ranger">Ranger</option><option value="rogue">Rogue</option><option value="sorcerer">Sorcerer</option><option value="wizard">Wizard</option><option value="adept">Adept</option><option value="aristocrat">Aristocrat</option><option value="commoner">Commoner</option><option value="expert">Expert</option><option value="warrior">Warrior</option></select></td><td align="right">Level #3: </td><td><input name="level3" maxlength="4" value="any" style="width: 36px;" type="text"></td></tr><tr><td colspan="2">Number to Generate <input name="n" maxlength="1" style="width: 24px;" value="1" type="text"></td><td colspan="2">Ability Score Generation:</td><td colspan="2"><select name="strat"><option value="4" selected="">Best 3 of 4d6</option><option value="3">Straight 3d6</option><option value="18">Straight 18</option><option value="h">Heroic</option><option value="a">Average (10-11)</option></select></td></tr><tr><td colspan="2">Show NPC Motivation <input name="b" ""="" type="checkbox"></td><td colspan="2"></td></tr></tbody></table><div style="text-align: right;"></div><br></div></form><button id="btnGenNPCs" class="button"><b>Generate NPCs!</b></button><div id=npcresults hidden style="overflow-y:scroll;max-height:350px"></div>'),$("#npcexplainbtn").click(function(){$("#npcexplain").toggle()}),$("#btnGenNPCs").off().click(function(){$.post(knownURLS.npcgenURL+"do=npcgen",$("#npggenpackage").serialize(),function(e){$("#npcresults").prepend($(e).find("div.clear.alt1")).show()})})}}function createLootGenDialog(){if($("#lootDialog").length>0)$("#lootDialog").dialog("open");else{$('<div id="lootDialog" title="Treasure Generator"><p>Loading...</p></div>').dialog({width:590,position:{my:"center top",at:"center bottom",of:$("#menu_bar")[0]}}).appendTo("head"),fixCloseButtonOnDialog(),$("div.ui-dialog.ui-front[aria-describedBy=lootDialog]").addClass("smallfont").append('<form id="lootpackage"><div style="color: #333;" class="col span-3"><span id="lootexplainbtn" class="button">Click to hide/show instructions</span><br/><div id="lootexplain" hidden style="font: 16px georgia; ">Welcome to the Dungeons &amp; Dragons Random Treasure Generator, originally developed for 3e by Jamis Buck, updated to 3.5e and maintained by Myth-Weavers. Check out our other generators from the Site Tools menu in the navigation!<br><br>This tool allows you to generate treasure for your encounters from a large variety of sources, including supplements, for D&amp;D 3.5e, with support for the older D&amp;D3e ruleset.<br><br>Just enter an encounter level, and optionally the various modifiers, and get your loot!</div><br><table style="width: 100%;"><tbody><tr><td style="width: 48%;" valign="top"><table style="width: 100%;"><tbody><tr><td style="width: 30px;"><input id="choiceEL" name="choice" value="EL" checked="" type="radio"></td><td colspan="2"><label for="choiceEL"><b>Generate Treasure by<br> Encounter Level</b></label></td></tr><tr><td></td><td>EL</td><td>&nbsp;<input name="result" maxlength="2" size="2" value="1" type="text"></td></tr><tr><td></td><td>Coins</td><td>x<input name="coins" maxlength="1" size="2" value="1" type="text"></td></tr><tr><td></td><td>Goods</td><td>x<input name="goods" maxlength="1" size="2" value="1" type="text"></td></tr><tr><td></td><td>Items</td><td>x<input name="items" maxlength="1" size="2" value="1" type="text"></td></tr></tbody></table></td><td valign="top">OR</td><td style="width: 48%;" valign="top"><table style="width: 100%;"><tbody valign="top"><tr><td style="width: 30px;"><input id="choiceIT" name="choice" value="IT" type="radio"></td><td colspan="2"><label for="choiceIT"><b>Generate Items</b></label></td></tr><tr><td></td><td># Items</td><td><input name="result2" maxlength="2" size="2" value="1" type="text"></td></tr><tr><td></td><td>Item Level</td><td><select name="itemtype[]" multiple="multiple" size="9" style="width: 100px;" class="multiple"><option value="armor" selected="">Armor</option><option value="weapon">Weapon</option><option value="potion">Potion</option><option value="ring">Ring</option><option value="rod">Rod</option><option value="scroll">Scroll</option><option value="staff">Staff</option><option value="wand">Wand</option><option value="wondrous item">Wondrous Item</option></select></td></tr><tr><td></td><td>Item Type</td><td><select name="itemlevel[]" multiple="multiple" size="3" style="width: 100px;" class="multiple"><option value="minor" selected="">Minor</option><option value="medium">Medium</option><option value="major">Major</option></select></td></tr></tbody></table></td></tr></tbody></table><hr><input value="1" name="ifset" type="checkbox"> Use the D&amp;D3e Ruleset instead of D&amp;D3.5e<br></div></form><div style="text-align: right;"><button id="btnGenLoot" class="button"><b>Generate Treasure!</b></button></div><div id=lootresults hidden style="overflow-y:scroll;max-height:350px"></div>'),$("#lootexplainbtn").click(function(){$("#lootexplain").toggle()}),$("#btnGenLoot").off().click(function(){$.post(knownURLS.lootgenURL+"do=treasure",$("#lootpackage").serialize(),function(e){$("#lootresults").prepend($(e).find("div.alt1")).show()})})}}function fixCloseButtonOnDialog(){$(".ui-dialog-titlebar-close").before("<img style='cursor:pointer' src='http://i.imgur.com/1qsyHoq.png' width='20px' align='right' />"),$(".ui-dialog-titlebar-close").prev("img").click(function(){var e=$(this).parents("div.ui-dialog").attr("aria-describedBy");$("#"+e).dialog("close")}).end().remove()}function createPBDialog(e){if($("#pbDialog").length>0)$("#pbDialog").dialog("open");else{var t=$("div.navbar.navbar-fixed-top")[0];if(e||(t=$("#menu_bar")[0]),$('<div id="pbDialog" title="Point buy calculator"><p style="z-index:101;">Loading...</p></div>').dialog({width:450,position:{my:"center top",at:"center bottom",of:t}}).appendTo("head"),fixCloseButtonOnDialog(),$("div.ui-dialog.ui-front[aria-describedBy=pbDialog]").addClass("smallfont").append('<h3>Bonuses</h3><div id="thelog" class="col-md-4"><form id="ability_bonus"><table><thead><tr><th>Str</th><th>Dex</th><th>Con</th><th>Int</th><th>Wis</th><th>Cha</th></tr></thead><tbody><tr><td><input name="str_bonus" type="text" pattern="[+-]?[0-9]+" value="0"></td><td><input name="dex_bonus" type="text" pattern="[+-]?[0-9]+" value="0"></td><td><input name="con_bonus" type="text" pattern="[+-]?[0-9]+" value="0"></td><td><input name="int_bonus" type="text" pattern="[+-]?[0-9]+" value="0"></td><td><input name="wis_bonus" type="text" pattern="[+-]?[0-9]+" value="0"></td><td><input name="cha_bonus" type="text" pattern="[+-]?[0-9]+" value="0"></td></tr></tbody></table></form></div><div id="dnddiv" class="col-md-4"><h3 id="dndh3">&#8630; D&amp;D3.5e</h3><form class="pb" name="pb_dnd35" id="pb_dnd35"><table><thead><tr><th>Base</th><th>Abil</th><th>Score</th><th>Mod</th></tr></thead><tbody><tr><th>Str</th><td><input type="number" name="str" value="8"></td><td><span id="dnd35_strFinal">8</span></td><td><span id="dnd35_strMod">-1</span></td></tr><tr><th>Dex</th><td><input type="number" name="dex" value="8"></td><td><span id="dnd35_dexFinal">8</span></td><td><span id="dnd35_dexMod">-1</span></td></tr><tr><th>Con</th><td><input type="number" name="con" value="8"></td><td><span id="dnd35_conFinal">8</span></td><td><span id="dnd35_conMod">-1</span></td></tr><tr><th>Int</th><td><input type="number" name="int" value="8"></td><td><span id="dnd35_intFinal">8</span></td><td><span id="dnd35_intMod">-1</span></td></tr><tr><th>Wis</th><td><input type="number" name="wis" value="8"></td><td><span id="dnd35_wisFinal">8</span></td><td><span id="dnd35_wisMod">-1</span></td></tr><tr><th>Cha</th><td><input type="number" name="cha" value="8"></td><td><span id="dnd35_chaFinal">8</span></td><td><span id="dnd35_chaMod">-1</span></td></tr></tbody><tfoot><tr><th>Points</th><td><span id="dnd35_total">0</span></td><td /><td /></tr></tfoot></table></form></div><div id="pfdiv" hidden class="col-md-4"><h3 id="pfh3">&#8630; Pathfinder</h3><form class="pb" name="pb_pf" id="pb_pf"><table><thead><tr><th>Base</th><th>Abil</th><th>Score</th><th>Mod</th></tr></thead><tbody><tr><th>Str</th><td><input type="number" name="str" value="10"></td><td><span id="pf_strFinal">10</span></td><td><span id="pf_strMod">+0</span></td></tr><tr><th>Dex</th><td><input type="number" name="dex" value="10"></td><td><span id="pf_dexFinal">10</span></td><td><span id="pf_dexMod">+0</span></td></tr><tr><th>Con</th><td><input type="number" name="con" value="10"></td><td><span id="pf_conFinal">10</span></td><td><span id="pf_conMod">+0</span></td></tr><tr><th>Int</th><td><input type="number" name="int" value="10"></td><td><span id="pf_intFinal">10</span></td><td><span id="pf_intMod">+0</span></td></tr><tr><th>Wis</th><td><input type="number" name="wis" value="10"></td><td><span id="pf_wisFinal">10</span></td><td><span id="pf_wisMod">+0</span></td></tr><tr><th>Cha</th><td><input type="number" name="cha" value="10"></td><td><span id="pf_chaFinal">10</span></td><td><span id="pf_chaMod">+0</span></td></tr></tbody><tfoot><tr><th>Points</th><td><span id="pf_total">0</span></td><td /><td /></tr></tfoot></table></form></div></div>'),$("#dnddiv h3").click(function(){$("#dnddiv").fadeOut(300).promise().done(function(){$("#pfdiv").fadeIn(300)})}),$("#pfdiv h3").click(function(){$("#pfdiv").fadeOut(300).promise().done(function(){$("#dnddiv").fadeIn(300)})}),$("#ability_bonus input").change(function(){$("#pb_dnd35 input, #pb_pf input").trigger("change")}).css("max-width","50px"),$(".pb input").change(pointBuy).attr("min",7).attr("max",18),e){for(var a in abils)if(log("abilsa: "+abils[a]+" & len: "+$("#statblock input.mod[name="+abils[a]+"]").length),!($("#statblock input.mod[name="+abils[a]+"]").length<1||""==$("#statblock input.mod[name="+abils[a]+"]").val())){var i=abils[a].toLowerCase(),n=parseInt($("#statblock input.mod[name="+abils[a]+"]").val());log("nam: "+i+" & val: "+$("#statblock input.mod[name="+abils[a]+"]").val()),$("#dnddiv input[name="+i+"]").val(n),$("#pfdiv input[name="+i+"]").val(n),$("#statblock input.tempmod[name="+abils[a]+"Temp]").length>0&&""!=$("#statblock input.tempmod[name="+abils[a]+"Temp]").val()&&$("#ability_bonus input[name="+i+"_bonus]").val(parseInt($("#statblock input.tempmod[name="+abils[a]+"Temp]").val())-n)}$("#thelog").parent().append(printFauxButton("applyToSheet","Apply","Apply to sheet")+printFauxButton("applyToSheet2","Apply temp","Apply to sheet using the temp scores as racial mods")),$("#applyToSheet").addClass("btn btn-primary").click(function(){$("#thelog").parent().find("div:visible > form.pb span[id]").each(function(){if(log("considering "+$(this).attr("id")),$(this).attr("id").includes("Final")){var e=$(this).attr("id").split("_")[1].replace(/Final$/,"");log("found "+e),e=e[0].toUpperCase()+e.slice(1),$('#statblock input[title="'+e+'"]')&&($('#statblock input[title="'+e+'"]').val($(this).text()),saveSheetShit($('#statblock input[title="'+e+'"]')))}})}),$("#applyToSheet2").addClass("btn btn-primary").click(function(){$("#thelog").parent().find("div:visible > form.pb span[id]").each(function(){if(log("considering "+$(this).attr("id")),$(this).attr("id").includes("Final")){var e=$(this).attr("id").split("_")[1].replace(/Final$/,"");log("found "+e);var t=parseInt($("#ability_bonus input[name="+e+"_bonus]").val());log("racial "+t),e=e[0].toUpperCase()+e.slice(1),$('#statblock input[title="'+e+'"]')&&($('#statblock input[title="'+e+'"]').val(parseInt($(this).text())-t),saveSheetShit($('#statblock input[title="'+e+'"]'))),$('#statblock input[title="'+e+'Temp"]')&&0!=t&&($('#statblock input[title="'+e+'Temp"]').val($(this).text()),saveSheetShit($('#statblock input[title="'+e+'Temp"]')))}})})}$("#pb_dnd35 input, #pb_pf input").trigger("change")}}function pointBuy(){var e={7:-1,8:0,9:1,10:2,11:3,12:4,13:5,14:6,15:8,16:10,17:13,18:16},t={7:-4,8:-2,9:-1,10:0,11:1,12:2,13:3,14:5,15:7,16:10,17:13,18:17},a=$(this),i=$(this).parents("form"),n={},o="";if("pb_dnd35"==i.attr("name"))n=e,o="dnd35";else{if("pb_pf"!=i.attr("name"))return void log("Unknown form");n=t,o="pf"}bonus=parseInt($("#ability_bonus input[name="+a.attr("name")+"_bonus]").val()),$("#"+o+"_"+a.attr("name")+"Final").text(parseInt(a.val())+bonus);var s=Math.floor((parseInt(a.val())+bonus-10)/2);s>=0&&(s="+"+s),$("#"+o+"_"+a.attr("name")+"Mod").text(s);var l=0;l+=n[i.find("input[name=str]").val()]+n[i.find("input[name=dex]").val()],l+=n[i.find("input[name=con]").val()]+n[i.find("input[name=int]").val()],l+=n[i.find("input[name=wis]").val()]+n[i.find("input[name=cha]").val()],isNaN(l)&&(l="Inconceivable!"),$("#"+o+"_total").text(l)}function addSiteWideButtons(e,t,a){sitewideHash||(sitewideHash=loadVal("sitewideHash",{cleansed:""})),saveVal("sitewideHash",sitewideHash),sitewideCounter||(sitewideCounter=Object.keys(sitewideHash).length),$("#MWGoldSitewideButtonContainer").find(":last").before("<DIV style='display:inline-block;'><b id='MWGoldSitewide"+sitewideCounter+"Name'>"+t+":</b> "+printFauxButton("MWGoldSitewide"+sitewideCounter+"Save","Copy","Copy current text to "+t)+printFauxButton("MWGoldSitewide"+sitewideCounter+"Load","Paste","Paste "+t+" at caret in textbox")+" | </DIV>"),$("#MWGoldSitewide"+sitewideCounter+"Name").click(function(){var e=$(this).attr("id").replace(/Name$/,"TextBox"),t=$(this).html().replace(/:$/,"");$(this).html("<input type='textbox' data-key='"+t+"' id='"+e+"' value='"+t+"'></input>"),$("#"+e).blur(function(){var e=$(this).attr("id").replace(/TextBox$/,"Name"),t=$(this).val();if(t&&""!=t&&t!=$(this).attr("data-key")){var a=sitewideHash[$(this).attr("data-key")];delete sitewideHash[$(this).attr("data-key")],sitewideHash[t]=a,saveVal("sitewideHash",sitewideHash)}$(this).remove(),$("#"+e).html(t+":").attr("data-texty","false")})}),$("#MWGoldSitewide"+sitewideCounter+"Save").attr("data-key",t).click(function(t){var a=getSelection(e);a&&""!=a?(sitewideHash[$("#"+t.target.id).attr("data-key")]=a,saveVal("sitewideHash",sitewideHash),putAnAlertSomewhere("Saved",$("#"+t.target.id).parent())):putAnAlertSomewhere("Select some text to copy",$("#"+t.target.id).parent())}),$("#MWGoldSitewide"+sitewideCounter+"Load").attr("data-key",t).click(function(t){sitewideHash||(sitewideHash=loadVal("sitewideHash",""));var a=getSelection(e),i=sitewideHash[$("#"+t.target.id).attr("data-key")];if(a&&""!=a)if(i.includes('""')){n=i.split('""');overwrite(e,n[0]+'"'+a.replace(/^"/,"").replace(/"$/,"")+'"'+n[1])}else if(i.includes("][/")){var n=i.split("][/");overwrite(e,n[0]+"]"+a+"[/"+n.slice(1).join("][/"))}else log("error retrieving "+$("#"+t.target.id).attr("data-key"));else insertAtCaret(e,i)}),sitewideCounter++}function addGameWideButtons(e,t,a){gamewideHash||(gamewideHash=loadVal("gamewideHash",{})),gamewideHash[a]||(gamewideHash[a]={}),saveVal("gamewideHash",gamewideHash),gamewideCounter||(gamewideCounter=Object.keys(gamewideHash).length),$("#MWGoldGamewideButtonContainer").attr("data-gameid",a).find(":last").before("<b data-texty='false' id='MWGoldGamewide"+gamewideCounter+"Name'>"+t+":</b> "+printFauxButton("MWGoldGamewide"+gamewideCounter+"Save","Copy","Copy current text to "+t)+printFauxButton("MWGoldGamewide"+gamewideCounter+"Load","Paste","Paste "+t+" at caret in textbox")+" | "),$("#MWGoldGamewide"+gamewideCounter+"Name").click(function(){if("true"!=$(this).attr("data-texty")){$(this).attr("data-texty","true");var e=$(this).attr("id").replace(/Name$/,"TextBox"),t=$(this).html().replace(/:$/,"");$(this).html("<input type='textbox' data-key='"+t+"' id='"+e+"' value='"+t+"'></input>"),$("#"+e).keypress(function(e){if(13==e.keyCode)return $(this).blur(),!1}),$("#"+e).blur(function(){var e=$(this).attr("id").replace(/TextBox$/,"Name"),t=$(this).val();if(t&&""!=t&&t!=$(this).attr("data-key")){var a=gamewideHash[$("#MWGoldGamewideButtonContainer").attr("data-gameid")][$(this).attr("data-key")];delete gamewideHash[$("#MWGoldGamewideButtonContainer").attr("data-gameid")][$(this).attr("data-key")],gamewideHash[$("#MWGoldGamewideButtonContainer").attr("data-gameid")][t]=a,$(this).attr("data-key",t),saveVal("gamewideHash",gamewideHash)}$(this).remove(),$("#"+e).html(t+":").attr("data-texty","false")})}}),$("#MWGoldGamewide"+gamewideCounter+"Save").attr("data-key",t).click(function(t){var i=getSelection(e);i&&""!=i?(gamewideHash[a][$("#"+t.target.id).attr("data-key")]=i,saveVal("gamewideHash",gamewideHash),putAnAlertSomewhere("Saved",$("#"+t.target.id).parent())):putAnAlertSomewhere("Select some text to copy",$("#"+t.target.id).parent())}),$("#MWGoldGamewide"+gamewideCounter+"Load").attr("data-key",t).click(function(t){if(gamewideHash||(gamewideHash=loadVal("gamewideHash","")),""!=gamewideHash){var i=getSelection(e),n=gamewideHash[a][$("#"+t.target.id).attr("data-key")];if(i&&""!=i)if(n.includes('""')){o=n.split('""');overwrite(e,o[0]+'"'+i.replace(/^"/,"").replace(/"$/,"")+'"'+o[1])}else if(n.includes("][/")){var o=n.split("][/");overwrite(e,o[0]+"]"+i+"[/"+o.slice(1).join("][/"))}else insertAtCaret(e,n);else insertAtCaret(e,n)}else log("error retrieving "+$("#"+t.target.id).attr("data-key"))}),gamewideCounter++}function makeContainer(e,t,a,i,n){if($("#MWGold"+t+"ButtonContainer").append(printFauxButton("MWGoldAdd"+t,"+","Click to add a new "+t+" button")),n)for(var o in a[n])i(e,o,n);else for(var o in a)i(e,o,n);$("#MWGoldAdd"+t).click(function(){var t=prompt("Please enter a name to store the thing as (hint: keeping it short = takes up less space)").replace(/[^\sa-z0-9]/gi,"");i(e,t,n)})}function tablify(e,t){var a=getSelection(e);if(""!=a)if(a.includes("|")){var i=a.split("\n"),n="",o=1,s=maxcol=0;for(var l in i){s=1;var r=i[l].split("|");for(var d in r){t["Max columns"]&&s>t["Max columns"]?(s=1,o++,maxcol=t["Max columns"]+1):s>10&&(s=2,o++,maxcol=10);var p=r[d];(t["Bold first column"]&&1==s||t["Bold first row"]&&1==o)&&(p="[b]"+p+"[/b]"),n+="[r="+s+","+o+"]"+p,s++}s>maxcol&&(maxcol=s),n+="\n",o++}overwrite(e,"[table="+(maxcol-1)+","+(o-1)+"]"+n.trim()+"[/table]")}else putAnAlertSomewhere('Separate columns with a pipe: "|" (shift+\\)',"#MWGoldTopTools");else putAnAlertSomewhere("Select some text to tablify","#MWGoldTopTools")}function OOCnote(e){var t=getSelection(e),a=prompt("What do you want the OOC mouseover to say?");null!=a&&overwrite(e,"[ooc="+t+"]"+a+"[/ooc]")}function img2insertion(e,t){var a=getSelection(e),i="[img2=100]",n="[/img2]";if(t&&(n+="[/ooc]",i="[ooc=][img2=490]"),""==a){var o,s=getMostUsedImage();if(null==(o=null==s?prompt("What's the link for the image?"):prompt("What's the link for the image?",s)))return;insertAtCaret(e,i+o+n)}else t?overwrite(e,"[ooc="+a+"][img2=490]"+prompt("What's the link for the image?")+n):overwrite(e,i+a+n)}function getMostUsedImage(){imageHash||(imageHash=loadVal("imageHash",{}));var e=-1,t=null;for(var a in imageHash)imageHash[a]>e&&(e=imageHash[a],t=a);return t}function fieldsetInsertion(e){var t,a=getSelection(e),i=prompt("What's the title for the fieldset(blank for none)?");null!=i&&(t=""==i?"setfield":"fieldset="+i,""==a?insertAtCaret(e,"["+t+"]\n\n[/"+t.split("=")[0]+"]"):overwrite(e,"["+t+"]"+a+"[/"+t.split("=")[0]+"]"))}function spoilerInsertion(e){var t=getSelection(e),a=prompt("What shall be the title/name (the visible text) of the spoiler?");null!=a&&(""==t?insertAtCaret(e,"[spoiler="+a+"]\n\n[/spoiler]"):overwrite(e,"[spoiler="+a+"]"+t+"[/spoiler]"))}function makeList(e){var t=getSelection(e);""==t?insertAtCaret(e,"[list]\n[*]\n[/list]"):overwrite(e,"[list]\n[*]"+t.replace(/\n/g,"\n[*]")+"\n[/list]")}function makeMiniMenu(e,t,a){$(e).after("<div id='"+t+"' hidden><span style='width:300;'></span></div>"),$(a).click(function(){"∧"==$(a).html()?$(a).html("∨"):($(a).html("∧"),$("#"+t).hide())}),$(a).hover(function(){$("#"+t).show()},function(){"∧"==$(a).html()&&$("#"+t).hide()})}function privateMessage(e,t){var a=getSelection(e);overwrite(e,"[private="+(t.length>0?t.join(", "):'" "')+"]"+a+"[/private]")}function makeAnyTag(e){var t=getSelection(e),a=prompt('Please enter the tag you\'d like to wrap around the text. Eg. "noparse" or "center"');null!=a&&overwrite(e,"["+a+"]"+t+"[/"+a+"]")}function selectiveQuote(e){var t=window.getSelection().toString();alert(t),insertAtCaret(e,"[quote]"+t+"[/quote]")}function generateToolkit(e,t){if($("#MWGoldToolsContainer").prev().after("<span float='right' id='MWGoldTopTools' class='smalltext'><span><input id='autoPreview' type='checkbox'>Auto-preview</span><img style='vertical-align: top;' src='http://i.imgur.com/TxZ3RPe.png' title='MWGold Toolkit' /><span style='background-color:#888888;padding:1px'>"+printFauxButton("makeTable","Tablify","Turns text like this into a table:\na|b|c\nd|e|f\ng|h|i")+"<span style='"+fauxButton+"' id='tmenu'>∧</span>"+printFauxButton("makeList","Listify","Puts list tags around selected text (if any), and makes each line a dot point")+printFauxButton("OOCnote","OOC","Attaches an OOC message to the selected text (if any)")+printFauxButton("img2","IMG2","Puts resizeable image tags around selected link, or, if nothing is selected, prompts you for a link")+printFauxButton("img2ooc","IMG2OOC","Puts ooc tags (around selected text, if any) containing resizeable image tags and prompts you for a link")+printFauxButton("fieldsetInsertion","Fieldset","Puts a fieldset around selected link (if any), prompts you for a title")+printFauxButton("spoilerInsertion","Spoiler","Puts spoiler tags around selected text (if any), prompts you for a title")+printFauxButton("privateMessage","Private","Puts private tags around selected text (if any), prompts you for a title")+"<span style='"+fauxButton+"' id='pmenu'>∧</span>"+printFauxButton("anyButton","Any","Puts tags around the selected text (if any), prompts you for which tags")+"</span></span>"),$("#img2").after("<span style='"+fauxButton+"' id='imenu'>∧</span>"),!$("#vB_Editor_QR").length||siteIs("pmURL")?($("#autoPreview").parent().remove(),$("#spoilerInsertion").remove(),$("#MWGoldTopTools").append(printFauxButton("autorequotifyButton","Requotify","Rearrange the quotes into paragraph, removing anyone but the most recent poster")),$("#autorequotifyButton").click(function(){if($("#"+e).length>0){var t=$("#"+e).val().split("]")[0]+"]";if(log("openQuote: "+t+" & quote count: "+$("#"+e).val().split(t).join("").split("[QUOTE=").length),$("#"+e).val().split(t).join("").split("[QUOTE=").length>0){var a=t+$("#"+e).val().slice(t.length).replace(/\[QUOTE=(.|\r?\n)+?(\[\/QUOTE\]\s*)+/gi,"").trim().replace(/(\S)\n\n\s*/g,"$1[/quote]\n\n"+t.toLowerCase()).trim();a.toLowerCase().endsWith("[/quote]")||(a+="[/quote]"),$("#"+e).val(a+"\n")}}})):($("#autoPreview").click(function(){$(this).prop("checked")?($(this).attr("data-sI",JSON.stringify(setInterval(function(){$("#vB_Editor_QR > input:last").click()},1e3))),log("set to: "+$(this).attr("data-sI")+" & found nodes: "+$("td.tcat:contains(Preview)").length)):(log("retrieved: "+$(this).attr("data-sI")),clearInterval(JSON.parse($(this).attr("data-sI"))))}),$("#spoilerInsertion").click(function(){spoilerInsertion(e)})),$("#makeList").click(function(){makeList(e)}),$("#makeTable").click(function(){var t={};$("#tmenucontent input.tmenucheckbox:checked").each(function(){t[$(this).attr("label")]=!0}),$("#tmenucontent input.tmenutextbox").each(function(){$(this).val()&&(t[$(this).attr("label")]=parseInt($(this).val()))}),tablify(e,t)}),$("#OOCnote").click(function(){OOCnote(e)}),$("#img2").click(function(){img2insertion(e,!1)}),$("#img2ooc").click(function(){img2insertion(e,!0)}),$("#anyButton").click(function(){makeAnyTag(e)}),$("#fieldsetInsertion").click(function(){fieldsetInsertion(e)}),$("#privateMessage").click(function(){var t=[];$("#pmenucontent").find("input:checked").each(function(){t.push($(this).attr("data-key"))}),privateMessage(e,t)}),makeMiniMenu("#MWGoldTopTools","tmenucontent","#tmenu"),$("#tmenucontent").append("<input type='checkbox' class='tmenucheckbox' label='Bold first row'/>Bold first row<br/>"),$("#tmenucontent").append("<input type='checkbox' class='tmenucheckbox' label='Bold first column'/>Bold first column<br/>"),$("#tmenucontent").append("<input type='textbox' class='tmenutextbox' width='10px' label='Max columns'/>Max columns"),makeMiniMenu("#MWGoldTopTools","pmenucontent","#pmenu"),t.length)for(var a in t)t[a]!=uName&&$("#pmenucontent").append("<div style='display:inline-block; background-color:#aaa; padding: 2px;'><input type='checkbox' "+(toggleHash["Private recipients checked by default"]?"checked":"")+" data-key='"+t[a]+"'>"+t[a]+"</input></div>");else $("#pmenucontent").append("You need to 'analyse' this thread to get the users who post here."+printFauxButton("analThisThread","Do it now","Just do it")),$("#analThisThread").click(analyseThread);makeMiniMenu("#MWGoldTopTools","imenucontent","#imenu"),imageHash||(imageHash=loadVal("imageHash",{}));var i=[];for(var n in imageHash)i.push([n,imageHash[n]]);if(i.length){i.sort(function(e,t){return e=e[1],t=t[1],e>t?1:e<t?-1:0});for(var o in i){$("#imenucontent").append("<div style='display:inline-block; background-color:#aaa; padding: 2px;'><img src='"+i[o][0]+"' width='100px' /></div>")}$("#imenucontent div img").click(function(t){var a=$(this).attr("src");imageHash[a].size?insertAtCaret(e,"[img2="+imageHash[a].size+"]"+a+"[/img2]"):insertAtCaret(e,"[img]"+a+"[/img]")})}else $("#imenucontent").append("<div style='display:inline-block; background-color:#aaa; padding: 2px;'>No images found. Spam some images on the boards to have them appear here.</div>")}function getThreadID(){var e=$('input[name="threadid"]').val();return e||(e=$("#qr_threadid").val()),!e&&$(location).attr("href").includes("t=")&&(e=$(location).attr("href").split("t=")[1].replace(/(\d+)\D.*/,"$1")),!e&&$('a[href*="showthread.php?t="]').length>0&&(e=$('a[href*="showthread.php?t="]').attr("href").split("t=")[1].replace(/(\d+)\D.*/,"$1")),e}function addEditorButtons(e,t){var a="none";$('#breadcrumb > li > a[href*="forumdisplay.php?f="]').length>1?a=$('#breadcrumb > li > a[href*="forumdisplay.php?f="]').eq(1).attr("href").split("=")[1]:$('#breadcrumb > li > a[href*="forumdisplay.php?f="]').length>0&&(a=$('#breadcrumb > li > a[href*="forumdisplay.php?f="]').eq(0).attr("href").split("=")[1]);var i,n=getThreadID();if(log("threadID="+n+" ("+typeof n+")"),log("gameID="+a+" ("+typeof a+")"),$("#"+e).css("height","300"),i="vB_Editor_QR"==t?"#qr_submit":"#vB_Editor_001_save",$(i).click(function(){$("#preview_output").html(""),analysePost($("#"+e).val()),saveVal("preventMWFromEating",$("#"+e).val())}),$(i).after(printFauxButton("preventMWFromEating","Recover post","If you have recently lost a post to MW, this button will try to recover it")+(siteIs("showThreadURL")?"<br>":"")),$("#preventMWFromEating").off().click(function(){$("#"+e).val(loadVal("preventMWFromEating",""))}),$("#"+e).blur(function(){$("#"+e).val()&&""!=$("#"+e).val()&&saveVal("preventMWFromEating",$("#"+e).val())}),toggleHash["Show toolkit"]){$("#"+t).append("<div align='right' id='MWGoldToolsContainer'>"),analysisHash||(analysisHash=loadVal("analysisHash",{}));var o=[];n&&analysisHash.Threads&&analysisHash.Threads[n]&&analysisHash.Threads[n].authors?o=Object.keys(analysisHash.Threads[n].authors):log("Thread ("+n+") not analysed properly or at all, failed to generate list of users"),generateToolkit(e,o)}if(toggleHash["Show game-wide templates"]&&n&&($("#"+t).append("<fieldset id='MWGoldGamewideButtonContainer'><legend class='smalltext'>Game-wide templates</legend></fieldset>"),gamewideHash||(gamewideHash=loadVal("gamewideHash",{})),makeContainer(e,"Gamewide",gamewideHash,addGameWideButtons,a)),toggleHash["Show site-wide templates"]&&($("#"+t).append("<fieldset id='MWGoldSitewideButtonContainer'><legend class='smalltext'>Site-wide templates</legend></fieldset>"),sitewideHash||(sitewideHash=loadVal("sitewideHash",{})),makeContainer(e,"Sitewide",sitewideHash,addSiteWideButtons,null)),"none"!=a&&toggleHash["Show dice composer"]&&n)if(myGames||(myGames=loadVal("myGames",{})),myGames[a]);else{$("#MWGoldToolsContainer").prepend("<fieldset id='MWGoldCharacterContainer'><legend class='smalltext'>Dice roll generator</legend><select style='max-width:50%' id='MWGoldSheetSelector'></select><br /><div id='MWGoldSweetShitContainer'></div></fieldset>"),$("#MWGoldSheetSelector").append("<option>None</option>"),sheetHash||(sheetHash=GM_getValue("sheetHash",null)),sheetHash||getListofSheets(!1),log("sheetHash.length: "+Object.keys(sheetHash).length);var s=Object.keys(sheetHash);for(var l in s)$("#MWGoldSheetSelector").append("<option>"+s[l]+"</option>");if(curByGame||(curByGame=loadVal("curByGame",{})),log("curByGame: "+curByGame+" ... key: "+a+" val: "+curByGame[a]),curByGame[a]){$("#MWGoldSheetSelector").val(curByGame[a]);var r=printSweetShit(e,curByGame[a]);r&&debugMode&&log("if (curByGame[gameID]): Error in printSweetShit: "+r)}$("#MWGoldSheetSelector").change(function(){if(curByGame||(curByGame=loadVal("curByGame",{})),curByGame[a]=$("#MWGoldSheetSelector").val(),saveVal("curByGame",curByGame),clearBuffs(),"None"==$("#MWGoldSheetSelector").val())$("#MWGoldSweetShitContainer").hide(),curSheet=null,$("#loadSheet").length>0&&$("#loadSheet").remove();else{$("#MWGoldSweetShitContainer").html("<b>MWGold:</b> Sweet Shit: Loading...").show(),curSheet=$("#MWGoldSheetSelector").val();var t=printSweetShit(e,curSheet);t&&debugMode&&log("$('#MWGoldSheetSelector').change: Error in printSweetShit: "+t)}})}}function printSweetShit(e,t){if(loadedSheets=loadVal("loadedSheets",{}),!t||!sheetHash[t])return"curSheet ("+t+") and/or sheetHash ("+sheetHash.length+") not defined!";var a=sheetHash[t];return null==a?"sheetName: "+t+" was not found in sheetHash":(curSheet!=t&&(curSheet=t),loadedSheets[curSheet]?(!toggleHash["Show character sheet at bottom of thread"]&&$("#deleteme").length>-1?$("#deleteme").remove():toggleHash["Show character sheet at bottom of thread"]&&$('<iframe id="charsheet"></iframe>').attr("src",knownURLS.sheetURL+sheetHash[curSheet]).appendTo("body"),$("#MWGoldSweetShitContainer").html(" "),$("#MWGoldSheetSelector").before(printFauxButton("loadSheet","Open sheet","Open selected character in a new tab")),$("#loadSheet").click(function(){window.open(knownURLS.sheetURL+sheetHash[curSheet])}),printSweetShitNoCheck("#MWGoldSweetShitContainer",e,t,a,"",!0),void $("#MWGoldSweetShitContainer").show()):$("#progress").length?(putAnAlertSomewhere("Automatic loading failed: you'll need to go to the character sheet manually","#MWGoldSweetShitContainer"),$("#MWGoldSweetShitContainer").append(printFauxButton("loadShitBelow","Open "+curSheet,"Open "+curSheet+' in a new tab, then click the "load to MW" button once the character sheet has loaded')),$("#loadShitBelow").click(function(){window.open(knownURLS.sheetURL+sheetHash[curSheet]),$("#MWGoldSweetShitContainer").html("Refresh this page once the sheet has loaded"),$("#MWGoldSweetShitContainer").append(printFauxButton("refresh","Refresh "+curSheet,"Refresh "+curSheet+" once it's done loading")),$("#refresh").click(function(){$(this).remove(),printSweetShit(e,t)})}),"sheet has not been loaded yet: automatic load failed"):($("#MWGoldSweetShitContainer").append('<b>MWGold:</b> <span id="progressText">Initialising...</span>  <div id="progress"></div>'),$("#progress").progressbar({value:1}),$("body").append('<iframe id="deleteme" style="height:0px"></iframe>'),toggleHash["Show character sheet at bottom of thread"]&&$("#deleteme").css("width","100%").css("height","450px").show(),$("#MWGoldSweetShitContainer").append(printFauxButton("refresh","Refresh "+curSheet,"Refresh "+curSheet+" once it's done loading")),$("#refresh").click(function(){$(this).remove(),printSweetShit(e,t)}),log("url for get: "+knownURLS.sheetURL+sheetHash[curSheet]),$("#progress").val(10),$("#progressText").html("Finding sheet..."),$("#deleteme").on("load",function(){waitForFire(scrape,$("#deleteme")[0].contentDocument,a)}),$("#deleteme").attr("src",knownURLS.sheetURL+sheetHash[curSheet]),"sheet has not been loaded yet: attempting to load it from sheet"))}function printSweetShitNoCheck(e,t,a,i,n,o){var s="Sheet_"+i,l=$(e).attr("id");log("our prefix string: '"+s+"' and sheetID: "+i+" and sheetName: "+a);var r,d=loadVal(s+"_hash",{});if(r=d.attacks?d.attacks:{},d.extraAttacks)for(var p in d.extraAttacks)r[p]=d.extraAttacks[p];if(!r||Object.keys(r).length<1)log("this sheet ("+a+") may not have been scraped properly! (no attacks)");else{$(e).append("Attacks: <select style='max-width:50%' id='MWGoldSweetAttacks_"+l+"_"+i+"'><option>Select to roll</option></select> | ");for(var p in r)$("#MWGoldSweetAttacks_"+l+"_"+i).append("<option>"+r[p].Name+"</option");$("#MWGoldSweetAttacks_"+l+"_"+i).change(function(){var e=$(this).val();if("Select to roll"==e)return!1;for(var a in r)r[a].Name==e&&insertAtCaret(t,n+makeAttackRollString(e,r[a]))})}var h;if(h=d.skills?d.skills:"",log("Skills JSONed: "+JSON.stringify(h)),""==h)log("this sheet ("+a+") may not have been scraped properly! (no skills)");else{$(e).append("Skills: <select class='MWGoldSweetSkills' style='max-width:50%' id='MWGoldSweetSkills_"+l+"_"+i+"'><option>Select to roll</option></select>");for(var c in h)$("#MWGoldSweetSkills_"+l+"_"+i).append("<option data-bonus='"+h[c].replace(/\+/g,"")+"'>"+c+"</option");$("#MWGoldSweetSkills_"+l+"_"+i).change(function(){var e=$(this).val();if("Select to roll"!=e){var a=e,i=isBuffed(["skills",e.toLowerCase()]);0!=i&&(a+=";with "+whichBuffs(["skills",e.toLowerCase()])),i+=parseInt(d.skills[e].replace(/\+/g,"")),insertAtCaret(t,n+makeRollString(a,"1d20+"+i))}})}var u;if(u=d.spells?d.spells:"",log("Spells JSONed: "+JSON.stringify(u)),""==u)log("this sheet ("+a+") may not have been scraped properly! (no spells)");else{$(e).append("<br/>Spells: <select style='max-width:50%' id='MWGoldSweetSpells_"+l+"_"+i+"'><option>Select to roll</option></select>");for(var c in u){var f=c;isNaN(parseInt(c[0]))||(f=c.slice(3)),$("#MWGoldSweetSpells_"+l+"_"+i).append("<option>"+f+"</option")}$("#MWGoldSweetSpells_"+l+"_"+i).change(function(){var e=$(this).val().replace(/\(.*?\)/g,"").replace(/\[.*?\]/g,"").trim();if("Select to roll"==e)return!1;var a="srd";d.CMB&&(a="pfsrd"),insertAtCaret(t,n+"[ooc="+e+"]["+a+"=spell]"+e+"[/"+a+"][/ooc]")})}var g,m=d;g=d.attributes?d.attributes:defaultAttributes,$(e).append(" | Misc: <select class='MWGoldSweetAttributes' style='max-width:50%' id='MWGoldSweetAttributes_"+l+"_"+i+"'><option>Select to roll</option></select>");for(var p in g)if(log("currently processing attribute: "+s+"_"+g[p]),m[g[p]]){var v=g[p];prettyAttributes[g[p]]&&(v=prettyAttributes[g[p]]),$("#MWGoldSweetAttributes_"+l+"_"+i).append("<option data-bonus='"+m[g[p]].replace(/\+/g,"")+"'>"+v+"</option")}else delete m[g[p]];if($("#MWGoldSweetAttributes_"+l+"_"+i).change(function(){var e=$(this).val(),a="";if("Select to roll"==e)return!1;for(var i in prettyAttributes)if(prettyAttributes[i]==e){a=i;break}""==a&&(a=e);var o=m[a].replace(/\+/g,""),s=e,l=[a.toLowerCase()];e.endsWith("attack")&&l.push("attack"),e.startsWith("Fort")&&(l=l.concat(["saves","fort"])),e.startsWith("Ref")&&(l=l.concat(["saves","ref"])),e.startsWith("Will")&&(l=l.concat(["saves","will"]));var r=isBuffed(l);r&&(o+=r,s+=";with "+whichBuffs(l)),insertAtCaret(t,n+makeRollString(s,"1d20+"+o))}),$(e).parent().prepend("<div style='float:left;max-width:25%'>"+printFauxButton("hideshowBuffs_"+l+"_"+i,"Buffs and conditionals","Click to hide/show the list of buffs and conditional modifiers this character has specified on their sheet.")+"<ul hidden id='buffs_"+l+"_"+i+"'></ul></div>"),$("#hideshowBuffs_"+l+"_"+i).click(function(){$(this).next().slideToggle()}),d.skillConditionals||d.attackConditionals||d.saveConditionals||d.buffBools){if(d.buffBools&&o)for(var b in d.buffBools)$("#buffs_"+l+"_"+i).append('<li><input type="checkbox" checked data-key="'+b+'">'+b+"</input></li>"),$("#buffs_"+l+"_"+i+" li:last input").change(function(){var e=$(this).attr("data-key");$(this).is(":checked")?buffsOn(e,d.buffBools[e]):buffsOff(e)}),buffsOn(b,d.buffBools[b]);if(d.attackConditionals){d.buffBools&&$("#buffs_"+l+"_"+i).append("<hr/>");for(var b in d.attackConditionals)$("#buffs_"+l+"_"+i).append('<li><input type="checkbox" data-key="'+d.attackConditionals[b]+'">'+d.attackConditionals[b]+"</input></li>")}if(d.skillConditionals){(d.attackConditionals||d.buffBools)&&$("#buffs_"+l+"_"+i).append("<hr/>");for(var b in d.skillConditionals)$("#buffs_"+l+"_"+i).append('<li><input type="checkbox" data-key="'+b+'">'+b+": "+d.skillConditionals[b].join(", ")+"</input></li>")}if(d.saveConditionals){(d.skillConditionals||d.attackConditionals||d.buffBools)&&$("#buffs_"+l+"_"+i).append("<hr/>");for(var b in d.saveConditionals)$("#buffs_"+l+"_"+i).append('<li><input type="checkbox" data-key="'+b+'">'+d.saveConditionals[b]+"</input></li>")}}else $("#buffs_"+l+"_"+i).append("<li style='text-decoration:underline'>No buffs or conditional modifiers found for this character, click to learn how to specify them</li>"),$("#buffs_"+l+"_"+i+" li").click(function(){$(this).remove(),$("#BuffInstructional").length>0?$("#BuffInstructional").dialog("show"):($('<div id="BuffInstructional" title="Specifying Gold Variables in Your Character Sheet and You" hidden></div>').dialog({width:800}).position({my:"center bottom",at:"center top",of:e}).appendTo("head"),fixCloseButtonOnDialog(),$("div.ui-dialog[aria-describedBy=BuffInstructional]").append("<div align='left'>Options can be set in your MW character sheet (including buffs)<br/>  by entering some lines beginning with '!' and specifying the values there, separated by ':'s.  <br/>  <br/>  Attributes are which boxes from the sheet you want the script to get. It gets everything it needs <br/>  by default, so it's just extra junk you want. Or you can put an '!' to not get certain boxes eg:<br/>  <span class='codeline'>!attributes: !CasterLevel, ActionPoints, SpellSlots1, !AC, !CMD</span><br/>  <br/>  Buffs are toggles that apply bonuses to your rolls.<br/>  \"!buff: name:affects:magnitude:affects:magnitude\". Multiple buffs must be on separate lines. <br/>      You can also delete with ! (even though none are given by default at this stage). eg: <br/>  <span class='codeline'>!buff:guidance:  attack:1:skills:1:saves:1</span><br/>  <span class='codeline'>!buff:!powerAttack</span><br/>  <span class='codeline'>!buff:divine favour:attack:1:damage:1</span><br/>  <span class='codeline'>!buff: power attack:   attack:-1:   damage:+2</span><br/>  <br/>  Attacks are extra attacks to add to the \"Attacks\" drop-down list (since MW sheets only allow for four)<br/>  \"!attack\" specifies additional weapons you might want to attack with. Only name, attack, and damage are required. <br/>      Unused options in the example: Range, Weight, Ammo, Special. eg:<br/>  <span class='codeline'>!attack:Spiked Gauntlet:attack:+6:Damage:1d4+4:Crit:x2:Size:M(light):Type:P</span><br/>  <br/>  Conditional modifiers are notes at the bottom of your Defences, Attacks, and Skills.<br/>  Save and attack conditional modifiers: specify text to add to the bottom of defences roll or attack rolls.<br/>      Multiple commands must be on separate lines. eg:<br/>  <span class='codeline'>!saveconditioNal: +1 luck to saves or dodge to AC if War Mind is active</span><br/>  <span class='codeline'>!attackconditional: +2 damage vs humanoids</span><br/>  <br/>  Skill conditional modifiers are slightly more complex as you need to specify the skill. <br/>  <span class='codeline'>!skillconditional: Spellcraft: +2 to id magic items</span><br/>  <span class='codeline'>!skillConditional: Perception:+8 to detect scents</span><br/>  <br/>  Last one is the easiest one. You don't need to include bonuses from buffs, the script will do that for you.<br/>     if you don't specify this, it will use the default: 1d3+@{StrMod}<br/>  <span class='codeline'>!unarmeddamage: 1d2+@{StrMod}</span><br/>  <span class='codeline'>!unarmeDDamage: 1d8+1.5*@{StrMod}</span><br/>  <br/>  Note: spaces and capital letters don't matter except for skills and attributes which must be capitalised.</div>"))});return!1}function getListofSheets(e){if(e){var t=GM_listValues();for(var a in t)t[a].startsWith("Sheet_")&&GM_deleteValue(t[a]);log("sheet content purged")}log("rescraping sheets..."),$.ajax({async:!1,type:"GET",url:knownURLS.sheetListURL,success:function(e){var t={};$(e).find('a[href*="sheet.html#id="]').each(function(){t[$(this).html().trim()]=$(this).attr("href").toString().split("=")[1]}),saveVal("sheetHash",t)}}),log("storing sheet data... "),sheetHash=loadVal("sheetHash",null),$("#rescrapeSheets")&&$("#rescrapeSheets").attr("title","Currently have: "+Object.keys(sheetHash).length+" characters"),log("setting session data... "+Object.keys(sheetHash).length)}function amnesia(){var e=GM_listValues();for(var t in e)GM_deleteValue(e[t]),log("deleted: "+e[t]);log("memory wipe complete"),location.reload()}function selectiveAmnesia(e){var t=GM_listValues();for(var a in t)t[a].startsWith(e)&&(GM_deleteValue(t[a]),log("deleted: "+t[a]));log("partial memory wipe complete")}function forgetAnalyses(){analysisHash=null,GM_deleteValue("analysisHash"),log("all gone")}function dejumpifyLinks(){$('a[href*="showthread.php?p="]').each(function(){$(this).attr("href",$(this).attr("href").split("#")[0])})}function putInWideButtonFieldset(e,t,a,i,n){$("#MWGoldCP").append("<fieldset id='"+i+"' style='max-width: "+(null==n?168:500)+"px;'><legend style='color: "+(null==n?"#ffffcc":"#571a19")+"'>"+e+"</legend></fieldset>");var o;o=null==n?Object.keys(t):Object.keys(t[n]);for(var s in o)log("fieldsetID: "+i+" & gameID: "+n+" & list[k]: "+o[s]+" & $('#'+fieldsetID):"+$("#"+i)),$("#"+i).html().includes("button")&&null==n&&$("#"+i).append("<br />"),$("#"+i).append("<button id='"+a+o[s].replace(/[^a-z]/gi,"")+"' data-key='"+o[s]+"' class='smallfont'>Forget "+o[s]+"</button>"),null==n?$("#"+a+o[s].replace(/[^a-z]/gi,"")).click(function(e){delete t[$("#"+e.target.id).attr("data-key")],saveVal("sitewideHash",t),$(this).remove()}):$("#"+a+o[s].replace(/[^a-z]/gi,"")).click(function(e){delete t[n][$("#"+e.target.id).attr("data-key")],saveVal("gamewideHash",t),$(this).remove()})}function siteIs(e){return"portalURL"==e?$(location).attr("href").endsWith(knownURLS.portalURL):$(location).attr("href").replace(/\.com\/\/+/g,".com/").startsWith(knownURLS[e])}function makeSomeNoise(){if(toggleHash["Audio notify when new messages are received"]){var e=loadVal("newMessageURL",defaultNewMessageURL);""==e&&(e=defaultNewMessageURL),$("#alertObject").length<1?($("body").append('<iframe id="alertObject" width="0" height="0" src="'+e+'" frameborder="0" wmode="Opaque"></iframe>'),log("created element: "+$("#alertObject")[0].outerHTML)):e!=$("#alertObject").attr("src")&&$("#alertObject").attr("src",e),$("#alertObject").length>0&&($("#alertObject")[0].play,log("played "+$("#alertObject").attr("src")))}}function widescreen(e){$("div.page").css("width",e+"%"),$("#headerShadow").css("width",(e>90?100:e+10)+"%"),$("#headerInner").css("width",e+"%"),$("#menu_bar").css("width","100%"),$("#poststop").length>0&&$("#poststop").next("div").removeClass("span-5").css("width","100%"),siteIs("portalURL")&&$("div.span-1").length>0&&$("div.span-1").removeClass("span-1"),siteIs("forumDisplayURL")&&$("div.span-1").length>0&&$("div.span-1").removeClass("span-1").css("width","15%").css("margin-right","0px"),siteIs("forumDisplayURL")&&$(".selectlist").length>0&&$(".selectlist").css("width","100%").parent().css("margin-right","0px"),siteIs("forumDisplayURL")&&$("div.span-4").length>0&&$("div.span-4").removeClass("span-4").css("width","85%").css("margin-right","0px"),$(".span-2").length>0&&($("div.span-2.smallfont").removeClass("span-2").css("width","25%").attr("align","right"),$("h1.span-2").removeClass("span-2").css("width","50%").attr("align","left").css("margin-right","0px")),$("div.span-3").length>0&&($("div.span-3.smallfont").removeClass("span-3").css("width","70%").css("margin-right","5%"),$("div.span-3").removeClass("span-3").css("width","50%").attr("align","right").css("margin-right","0px")),$("div.span-5").length>0&&$("div.span-5").removeClass("span-5").css("width","100%"),$("div.span-4").length>0&&$("div.span-4").removeClass("span-4").css("width","100%"),siteIs("userCPURL")&&$("#threadslist").length>0&&$("#threadslist").parent().css("width","100%").prev().css("width","100%"),$("#threadgroups").length>0&&$("#threadgroups").css("width","").parent().css("margin-right","0px"),$("#vB_Editor_QR").length>0&&widescreen_firstpass&&$("#vB_Editor_QR").parent().css("width","80%").css("max-width",""),$("#vB_Editor_001_textarea").length>0&&widescreen_firstpass&&$("#vB_Editor_001_textarea").css("width","100%").css("max-width",""),(siteIs("forumDisplayURL")||siteIs("newReplyURL")||siteIs("newThreadURL")||siteIs("editPostURL"))&&$("#vB_Editor_001").length>0&&widescreen_firstpass&&$("#vB_Editor_001").parents('div[style="width:747px"]').css("width","100%").css("max-width","").end().parents("table").css("width","98%").css("background-color","lightgrey"),widescreen_firstpass=!1}function getMyGames(){log("scraping games..."),myGames={},$.ajax({async:!1,type:"GET",url:knownURLS.userCPURL,success:function(e){$(e).find("#collapseobj_usercp_forums > tr > td:nth-child(2) > a:nth-child(1)").each(function(){log("spawning getter for "+$(this).text()),$.ajax({async:!1,type:"GET",url:$(this).attr("href"),success:function(e){$(e).find("#fd_game_links").children().length>2&&(myGames[$(e).find("#inlinemodform").attr("action").split("=")[1]]={name:$(e).find("#fd_game_links").next().find("h1:first").text(),pinnedPCs:{},pinnedNPCs:{}},log("gameID: "+$(e).find("#inlinemodform").attr("action").split("=")[1]+" & name: "+$(e).find("#fd_game_links").next().find("h1:first").text()))}})})}}),saveVal("myGames",myGames)}function improveThreads(){if($("#threadslist").length>0&&$(".MWGoldThreadButtonContainer").length<1&&toggleHash["Add extra buttons to threads"]){var e=$("ul.buttonbar").length<3;$("#threadslist li").each(function(){var t=$(this).children("div[id]").attr("id").replace(/\D+/g,""),a=$(this).find("span:first").text().includes("Sticky:");toggleHash.Widescreen?$("#td_threadtitle_"+t).after('<div id="MWGoldThreadButtonContainer'+t+'" class="smallfont MWGoldThreadButtonContainer" style="position: absolute; right: 170px; width: 105px; top: 4px; white-space:nowrap"></div>'):($(this).find("span:first").attr("id","MWGoldThreadButtonContainer"+t).addClass("smallfont MWGoldThreadButtonContainer"),$("#MWGoldThreadButtonContainer"+t).html($("#MWGoldThreadButtonContainer"+t).html().replace(/Sticky: /g,e?"Sticky: ":"").replace(/^\s+<br>/,"").replace(/([^<]+?)\s*<br>/g,"$1 "))),$("#MWGoldThreadButtonContainer"+t).attr("data-thread-id",t).css("font","").css("font","bold"),$("#MWGoldSub"+t).length<1&&(subbedThreads||(subbedThreads=loadVal("subbedThreads",[])),$("#MWGoldThreadButtonContainer"+t).append(subbedThreads.includes(t)?'<span id="MWGoldSub'+t+'" class="MWGoldSub smallfont">Subbed</span>':printFauxButton("MWGoldSub"+t,"Sub","Subscribe to this thread"))),$("#MWGoldPin"+t).length<1&&(pinnedThreads||(pinnedThreads=loadVal("pinnedThreads",{})),$("#MWGoldThreadButtonContainer"+t).append(printFauxButton("MWGoldPin"+t,pinnedThreads[t]?"Unpin":"Pin",pinnedThreads[t]?"Unpin this thread":"Pin this thread")),$("#MWGoldPin"+t).addClass("MWGoldPin")),e||$("#MWGoldStick"+t).length<1&&(a?$("#MWGoldSub"+t).before(printFauxButton("MWGoldStick"+t,"Stuck","Unstick this thread")):$("#MWGoldSub"+t).before(printFauxButton("MWGoldStick"+t,"Stick","Stick this thread")),$("#MWGoldStick"+t).addClass("MWGoldStick"))}),$("#threadslist li .MWGoldSub").click(function(){subToThread($(this).parent().attr("data-thread-id"))}),$("#threadslist li .MWGoldPin").click(function(){var e=$(this).parent().attr("data-thread-id");pinnedThreads||(pinnedThreads=loadVal("pinnedThreads",{})),pinnedThreads[e]?delete pinnedThreads[e]:pinnedThreads[e]=$("#td_threadtitle_"+e+" > a[id]").text(),saveVal("pinnedThreads",pinnedThreads),$(this).text(pinnedThreads[e]?"Unpin":"Pin"),$(this).attr("title",pinnedThreads[e]?"Unpin this thread":"Pin this thread")}),$("#threadslist li .MWGoldStick").click(function(){var e=$(this).parent().attr("data-thread-id");log("getting: https://www.myth-weavers.com/showthread.php?t="+e),Promise.resolve($.post("https://www.myth-weavers.com/postings.php?t="+e+"&pollid=",{do:"stick",t:e,securitytoken:$("input[name=securitytoken]").val()})).then(function(){$("#threadslist").load(location.href+" #threadslist")}).then(improveThreads)})}}function subToThread(e){e&&(log("subbing to: https://www.myth-weavers.com/showthread.php?t="+e),subbedThreads||(subbedThreads=loadVal("subbedThreads",[])),subbedThreads.includes(e)||(subbedThreads.push(e),saveVal("subbedThreads",subbedThreads),$.post("https://www.myth-weavers.com/subscription.php?do=doaddsubscription&threadid="+e,{do:"doaddsubscription",threadid:e,emailupdate:0,folderid:0,securitytoken:$("input[name=securitytoken]").val()})))}function printPinnedThreads(){if(!($("#pinnedThreads").length>0)){$("#collapseobj_usercp_forums").parent().siblings("table:last").attr("id","pinnedThreads"),pinnedThreads=loadVal("pinnedThreads",{});for(var e in pinnedThreads)$("#pinnedThreads > thead").length<1&&$("#pinnedThreads").append('<thead><tr><td class="tcat" colspan="5"><a style="float:right" href="#top"><img src="https://static.myth-weavers.com/images/sonata/buttons/collapse_tcat.gif" alt="" border="0"></a>Pinned Threads</td></tr></thead>'),$("#pinnedThreads > tbody").append("<tr><td class='alt2'> <a href='"+knownURLS.showThreadURL+"?t="+e+"'> "+pinnedThreads[e]+" </a> </td></tr>"),$("#pinnedThreads > tbody > tr:last").append("<td>"+printFauxButton("pin_"+e+"_nickname","Nickname","Give this pin a nickname")+"</td>"),$("#pin_"+e+"_nickname").click(function(){var e=prompt("What would you prefer to call "+$(this).parent().prev().text()+"?");$(this).parent().prev().find("a:first").text(e),pinnedThreads[$(this).attr("id").replace(/\D/g,"")]=e,saveVal("pinnedThreads",pinnedThreads)})}}function makeTabbable(e,t,a){$("#"+t).length<1&&($(a).after("<form id='"+t+"'><br/><br/><b>MW Gold: Loading...</b></form>"),$.get(e,function(e){$("#"+t).html($(e).find("#breadcrumb").parent().html()),$("#"+t).addClass("subform").children(":lt(4)").remove(),toggleHash.Widescreen&&widescreen(loadVal("width",90)),toggleHash["Show footer"]||$('div[style="text-align: center; padding: 12px;"]').fadeOut().prev().html("<span style='width:100%'></span>"),$(".ad_cs_link").remove(),"GMScreenForm"==t&&pinShiz("#"+t)})),$(".subform").hide(),$("#"+t).show()}function pinShiz(e){myGames||(myGames=loadVal("myGames",""));var t=$(location).attr("href").split("=")[1];if(""==myGames||!myGames[t]||Object.keys(myGames[t].pinnedNPCs).length<1&&Object.keys(myGames[t].pinnedPCs).length<1)$(e).append('<div class="tcat" style="padding-left: 10px">No Pinned Characters</div>','<div class="alt1" style="padding: 10px">Browse to some character sheets, click "configurate", and add them to this game.</div>');else{var a=Object.keys(myGames[t].pinnedPCs).length,i=Object.keys(myGames[t].pinnedNPCs).length,n=1,o=Math.max(i,a);for($(e).find("form > div.alt1 > textarea").attr("id","theArea").css("width","100%").after('<fieldset id="MWGoldSweetShitContainer" style="width: 97%; min-height: 150px;"><legend>Dice roller</legend></fieldset>'),$(e).children("form").after('<div class="tcat" style="padding-left: 10px">Pinned Characters</div>','<div class="alt1" style="padding: 10px"><table class="span-4"><thead><tr class="span-4"><th class="span-2">PCs</th><th class="span-2">NPCs</th></tr></thead><tbody id="pinnedCharsHead"></tbody></table></div>');n<=o;n++)$("#pinnedCharsHead").append('<tr class="span-4"></tr>');if(a>0){n=1;for(var s in myGames[t].pinnedPCs)insertPinnedChar("#pinnedCharsHead tr:nth-child("+n+++")",t,s,!0),$("#MWGoldSweetShitContainer").append("<fieldset><legend class='smalltext'>"+myGames[t].pinnedPCs[s]+"</legend><div id='MWGoldSweetShitContainer_"+s+"' style='display:inline-block;float:right'></div></fieldset>"),log("printSweetShit result: "+printSweetShitNoCheck("#MWGoldSweetShitContainer_"+s,"theArea",myGames[t].pinnedPCs[s],s,"\n"+myGames[t].pinnedPCs[s]+": ",!1))}else $("#pinnedCharsHead tr:first").append('<td class="span-2">None</td>');for(n=Math.max(a+1,2);n<=o;n++)$("#pinnedCharsHead tr:nth-child("+n+")").append('<td class="span-2"></td>');if(i>0){n=1;for(var l in myGames[t].pinnedNPCs)insertPinnedChar("#pinnedCharsHead tr:nth-child("+n+++")",t,l,!1),$("#MWGoldSweetShitContainer").append("<fieldset><legend class='smalltext'>"+myGames[t].pinnedNPCs[l]+"</legend><div id='MWGoldSweetShitContainer_"+l+"' style='display:inline-block;float:right'></div></fieldset>"),log("printSweetShit result: "+printSweetShitNoCheck("#MWGoldSweetShitContainer_"+l,"theArea",myGames[t].pinnedNPCs[l],l,"\n"+myGames[t].pinnedNPCs[l]+": ",!1)),$("#MWGoldSweetShitContainer_"+l).parent().hide()}else $("#pinnedCharsHead tr:first").append('<td class="span-2">None</td>');$("#pinnedCharsHead").find("input[type=checkbox]").change(function(){log("sheetID: "+$(this).val()),$("#MWGoldSweetShitContainer_"+$(this).val()).parent().slideToggle()}),clearBuffs(),$("#MWGoldSweetShitContainer").prepend("<div>Skills: <select style='max-width:50%' id='MWGoldSweetSkills_All'></select> | Misc: <select style='max-width:50%' id='MWGoldSweetAttributes_All'></select></div>");var r={};$("#MWGoldSweetShitContainer select.MWGoldSweetSkills option").each(function(){r[$(this).text()]=1});for(var d in r)$("#MWGoldSweetSkills_All").append("<option>"+d+"</option>");r={},$("#MWGoldSweetShitContainer select.MWGoldSweetAttributes option").each(function(){r[$(this).text()]=1});for(var d in r)$("#MWGoldSweetAttributes_All").append("<option>"+d+"</option>");$("#MWGoldSweetSkills_All").change(function(){var e=$(this).val();$("#MWGoldSweetShitContainer fieldset:visible select.MWGoldSweetSkills option").each(function(){$(this).prop("selected",$(this).text()==e)}),$("#MWGoldSweetShitContainer fieldset:visible select.MWGoldSweetSkills").change()}),$("#MWGoldSweetAttributes_All").change(function(){var e=$(this).val();$("#MWGoldSweetShitContainer fieldset:visible select.MWGoldSweetAttributes option").each(function(){$(this).prop("selected",$(this).text()==e)}),$("#MWGoldSweetShitContainer fieldset:visible select.MWGoldSweetAttributes").change()})}}function insertPinnedChar(e,t,a,i){$(e).append('<td class="span-2"><input value="'+a+'" type="checkbox" '+(i?'checked="checked"':"")+'> <a href="'+knownURLS.sheetURL+a+'">'+myGames[t]["pinned"+(i?"":"N")+"PCs"][a]+'</a><span data-isPC="'+i+'" data-sheetID="'+a+'" id="'+a+'_controls" style="display:inline-block;float:right">'+printFauxButton("unpin_"+a,"Unpin","Upin this sheet from this game")+"</span></td>"),$("#unpin_"+a).click(function(){var e="true"==$(this).parent().attr("data-isPC"),a=$(this).parent().attr("data-sheetID");log("Unpinned "+(e?"":"N")+"PC with sheetID:"+a),delete myGames[t]["pinned"+(e?"":"N")+"PCs"][a],saveVal("myGames",myGames),$(this).parent().parent().html(""),$("#MWGoldSweetShitContainer_"+a).parent().remove()})}function refreshStuff(){setInterval(refreshShit,45e3),setInterval(fillInFriends,55e3),siteIs("portalURL")&&toggleHash["Rearrange front page"]&&setInterval(rearrangeEntry,4e4),(siteIs("showThreadURL")||siteIs("newReplyURL")||siteIs("editPostURL"))&&setInterval(detectNinjas,35e3)}function detectNinjas(){var e=getThreadID(),t=$("#breadcrumb li:last").prev().find("a[href^=http]").attr("href");$.get(t+" #td_threadstatusicon_"+e,function(e){$(e).find("img").attr("src")==staticNewMessageImage&&$("#newMessageITTAlert").length<1&&(log("****** ninja detected! ******"),$('<div title="Ninja detected!" id="newMessageITTAlert"><strong>There is a new message in this thread.</strong></div>').appendTo("body"),$("#newMessageITTAlert").dialog({position:{my:"right top",at:"right top",of:$("#headerContainer")[0]}}),$("div.ui-dialog[aria-describedBy=newMessageITTAlert]").css("position","fixed"))})}function notifyInUserCPButton(e){var t=($(e).find("#threadslist")?$(e).find("#threadslist").children().length:0)+($(e).find("#collapseobj_usercp_pms")?$(e).find("#collapseobj_usercp_pms").children().length:0);$('a[href="'+knownURLS.userCPURL+'"]').html("User CP <b>("+t+")</b>"),toggleHash["Audio notify when new messages are received"]&&(newMessagesLastTime=loadVal("newMessagesLastTime",0),toggleHash["Remind me of unread messages"]&&(newMessagesLastTime=0),t>newMessagesLastTime&&($.titleAlert(t+" new messages",{interval:500}),makeSomeNoise()),saveVal("newMessagesLastTime",newMessagesLastTime=t))}function getAllPeeps(){if(toggleHash["Show who is browsing subscribed games"]&&(siteIs("userCPURL")||siteIs("portalURL")))for(var e in subscribedForumLinks)getPeepsInThatGame(subscribedForumLinks[e])}function getPeepsInThatGame(e){$.get(e,function(t){var a=e.split("=")[1],i=$(t).find("div.smallfont.col > span.smallfont").html().replace(/(\n|\+)/g,"").split(",");i.length>1&&log("link: "+e+" found peeps: "+JSON.stringify(i));for(var n in i)if(i[n].includes(uName)){i[n]=null,i=cleanArray(i);break}var o;o=siteIs("portalURL")?$('img[src="http://static.myth-weavers.com/images/sonata/statusicon/subforum_old.gif"]').parent().find('a[href="'+e+'"]')[0]:$('#collapseobj_usercp_forums > tr[align!="center"] > td > a[href="'+e+'"]')[0],i.length>0?$(o).after("<br /><a hidden id='MWGoldPeeps_"+a+"' style='padding-left:10px' class='smallfont'>Browsing: "+i.join(", ")+"</a>"):$(o).after("<br /><a hidden id='MWGoldPeeps_"+a+"' style='padding-left:10px' class='smallfont'>Empty</a>"),$("#MWGoldPeeps_"+a).fadeIn()})}function refreshShit(){$.get(knownURLS.userCPURL,function(e){var t=$("#timenow").children().attr("title");for(var a in refreshThisStuff)("#timenow"!=a||toggleHash["Keep time current"])&&$(refreshThisStuff[a]).html($(e).find(refreshThisStuff[a]).html());$("#timenow").children().attr("title",t),($(e).find("#threadslist").length>0||$(e).find("#collapseobj_usercp_pms").length>0)&&siteIs("userCPURL")&&($("#collapseobj_usercp_forums").parents("td").html($(e).find("#threadslist").parents("td").html()),$("#collapseobj_usercp_pms").length>0&&$(e).find("#collapseobj_usercp_pms").length>0?$("#collapseobj_usercp_pms").html($(e).find("#collapseobj_usercp_pms").html()):$(e).find("#collapseobj_usercp_pms").length>0&&$("#collapseobj_usercp_forums").parents("td").prepend($(e).find("#collapseobj_usercp_pms").parents("table")[0].outerHTML)),notifyInUserCPButton(e)}).promise().done(function(){siteIs("userCPURL")&&(getAllPeeps(),printPinnedThreads()),$("#threadslist").length>0&&improveThreads(),toggleHash.Widescreen&&widescreen(loadVal("width",90)),dejumpifyLinks()})}function findOnlineFriends(e){var t=[];if(!uNum||$(e).find("#collapseobj_forumhome_activeusers").length<1)return t;var a=$(e).find("#collapseobj_forumhome_activeusers").find('a[href="member.php?'+uNum+'"]').parent().html().split(",");for(var i in a)a[i].indexOf("+")>-1&&t.push(a[i].replace(/\+/g,""));return t}function fillInFriends(){toggleHash["Show online friends"]&&$.get(knownURLS.portalURL,function(e){$("#social").html("<div id='socialFriends' style='color: #ffffcc' align='right'><b>Friends Online:</b> </div>");var t=findOnlineFriends(e);$("#socialFriends").append(t.join(", ").replace(/\<a/g,"<a style='color:#ffffcc'")),onlineFriends||(onlineFriends=loadVal("onlineFriends",{}));for(var a in onlineFriends)if(!t.includes(a))if(Date.now()-onlineFriends[a]>18e5)delete onlineFriends[a];else{var i="";$("#socialFriends").children("a").length>0&&(i=", "),$("#socialFriends").append(i+a.replace(/\<a/g,"<a style='color:#eeeeee'"))}$("#socialFriends").append("<span style='display: inline-block;width:10%'></span>");for(var a in t)onlineFriends[t[a]]=Date.now();saveVal("onlineFriends",onlineFriends)})}function rearrangeEntry(){$.get(knownURLS.portalURL,function(e){rearrangePortal($("<div/>").html(e).contents())})}function rearrangePortal(e){$(e).find("#forumhome_forumlist > li:first").css("margin-right","0").after('<li id="portalBox0" style="height: 120px; margin-right: 0px;"></li>');var t="";$(e).find("#forumhome_forumlist + div").children(":eq(1)").children().each(function(){t+=$(this).html()+"<br/>"}),$(e).find("#portalBox0").attr("class","col span-1").css("padding","5px").append("<h3><a>"+$(e).find("#forumhome_forumlist + div").children(":eq(0)").html()+"</a></h3>").append("<div>"+t+"</div>"),$(e).find("#forumhome_forumlist + div").remove(),log("fucking with children");var a=2,i={snap:!0,stop:function(e,t){log("entry for "+e.target.id),saveVal("pos_"+e.target.id,{top:$("#"+e.target.id).css("top"),left:$("#"+e.target.id).css("left")})}};$(e).find("#forumhome_forumlist").attr("class","col span-6").children("li:gt(1)").each(function(){$(this).attr("class","col span-1").css("padding","5px").attr("id","portalBox"+a),$(this).children(":eq(0)").attr("title",$(this).children(":eq(1)").html()),$(this).children(":eq(1)").remove(),$(this).children(":eq(1)").attr("class","smallfont").css("max-width","150").css("margin-left","15"),$(this).children(":eq(1)").children("a").css("white-space","normal"),a++}),$(e).find("#forumhome_forumlist > li:first").attr("id","portalBox1").css("padding","5px").attr("class","col span-1").children(":eq(1)").attr("class","smallfont").css("max-width","150").css("margin-left","15").children("a").css("white-space","normal"),log("done: returning: "+a);for(var n=0;n<a;n++)if($("#portalBox"+n).length){var o=loadVal("pos_portalBox"+n,null),s=loadVal("size_portalBox"+n,null);o&&$(e).find("#portalBox"+n).css("left",o.left).css("top",o.top),s&&$(e).find("#portalBox"+n).css("height",s.height).css("width",s.width),$("#resizeStuff").is(":checked")&&$(e).find("#portalBox"+n).attr("class","col span-1 ui-widget-content").resizable({stop:function(e,t){log("entry for "+e.target.id),saveVal("size_"+e.target.id,{width:$("#"+e.target.id).css("width"),height:$("#"+e.target.id).css("height")})}}).css("background","transparent"),$(e).find("#portalBox"+n).draggable(i),$("#portalBox"+n).replaceWith($(e).find("#portalBox"+n))}}function scrape(e,t){var a;sheetHash||(sheetHash=loadVal("sheetHash",null));for(var i in sheetHash)if(sheetHash[i]==t){a=i;break}log("entry: sheetID: "+t+" & sheetName: "+a),a&&t&&scrapeWithName(e,t,a)}function scrapeWithName(e,t,a){var i,n="Sheet_"+t,o=parseOverrides($(e).find('textarea[title="Notes"]').val());i=o.attributes?o.attributes:defaultAttributes;var s=GM_listValues();for(var l in s)s[l].startsWith(n)&&GM_deleteValue(s[l]);for(var r in i)o[i[r]]=$(e).find("input[title='"+i[r]+"']").val();for(var d in abils)""!=$(e).find('input[title="'+abils[d]+'Temp"]').val()&&(o[abils[d]+"Mod"]=$(e).find('input[title="'+abils[d]+'TempMod"]').val());for(var p=[],r=1;r<5;r++)if(S=$(e).find("input[name='Weapon"+r+"']").val()){var h={Name:S};log("scraping attack: '"+S+"'");for(var c in props)h[props[c]]=$(e).find("input[name='Weapon"+r+props[c]+"']").val();p.push(h)}p=cleanArray(p),o.attacks=p,log("total attacks found: "+p.length+" for "+a);var u="0",f=35;knownGear||(knownGear=loadVal("knownGear",[])),$(e).find("input[name='Gear43']").length>0&&(f=44);for(r=1;r<f;r++)if(10==r&&(u=""),S=$(e).find("input[name='Gear"+u+r+"']").val().trim()){var g=$(e).find("input[name='Gear"+u+r+"W']").val().trim(),m=null;g&&""!=g||!/\d\s?lb/.test(S)||(g=S.replace(/.*\D+(\d+\.?\d?\s?lb).*/,"$1")),/\d\s?[pgsc]p/.test(S)&&(m=S.replace(/.*\D*(\d+\.?\d?\s?[pgsc]p).*/,"$1"));var v={label:S,weight:g};null!=m&&(v.cost=m);var b=$.inArray(S,knownGear.map(function(e){return e.label}));-1==b?knownGear.push(v):(v.weight&&""!=v.weight&&(knownGear[b].weight=v.weight),v.cost&&""!=v.cost&&(knownGear[b].cost=v.cost))}saveVal("knownGear",knownGear),log("total items found (all time, not just this run): "+Object.keys(knownGear).length);var y=loadVal("knownFeats",[]);$(e).find("input[name*='Feat']").each(function(){var e=$(this).val();e&&""!=e&&-1==$.inArray(e,y)&&y.push(e)}),saveVal("knownFeats",y);for(var w={},u="0",r=1;r<52;r++)10==r&&(u=""),(S=$(e).find("input[name='Skill"+u+r+"']").val().replace(/^\#/,"").replace(/\*\s*$/g,""))&&(w[S]=$(e).find("input[name='Skill"+u+r+"Mod']").val());o.skills=w,log("total skills found: "+Object.keys(w).length+" for "+a);var k={};u="0",knownSpells||(knownSpells=loadVal("knownSpells",[]));for(r=1;r<67;r++){10==r&&(u="");var S=$(e).find("input[name='Spell"+u+r+"']").val();S&&(k[S]=$(e).find("input[name='Spell"+u+r+"Cast']").val(),-1==$.inArray(S,knownSpells)&&knownSpells.push(S))}saveVal("knownSpells",knownSpells),o.spells=k,log("total spells found: "+Object.keys(k).length+" for "+a),saveVal(n,a),loadedSheets||(loadedSheets=loadVal("loadedSheets",{})),loadedSheets[a]=t,log("added "+a+" to loadedSheets"),saveVal("loadedSheets",loadedSheets),saveVal(n+"_hash",o),$("#progress").length>-1&&($("#progressText").html("Done! Changing to "+a),$("#progress").val(100),$("#MWGoldSheetSelector").trigger("change")),log("return: '"+t+"' to '"+n+"_hash'")}function parseOverrides(e){var t,a=[],i={},n=[],o={},s={},l=[],r=e.split("\n");log("entry: overrideCharacterID: ! & line count: "+r.length);var d={};for(var p in r)if("!"==r[p][0]){var h=r[p].slice(1);if(h.includes(":")){log("found override line: "+r[p]);var c=h.split(":")[0].trim().toLowerCase();switch(c){case"attributes":var u=h.split(":").slice(1).join(":").trim().split(",");for(var f in u){var g=u[f].trim();"!"==g[0]?l=$.grep(l,function(e){return e!=g.slice(1)}):-1==$.inArray(g,l)&&l.push(g)}d.attributes=l;break;case"buff":var m=h.split(":").slice(1).join(":").trim(),v=m.split(":")[0].trim();if("!"==v[0])delete o[v.replace(/^\!/,"")];else{x={};if((_=m.split(":").slice(1)).length%2){log("could not parse buff: could not find a key for each value: "+h);continue}for(var b=0,p=_.length;b<p;b+=2){var y=_[b].trim().toLowerCase(),w=_[b+1].trim();"attacks"==y&&(y="attack"),x[y]=w}o[v]=x}d.buffBools=o;break;case"saveconditional":a.push(h.split(":").slice(1).join(":").trim()),d.saveConditionals=a;break;case"attackconditional":n.push(h.split(":").slice(1).join(":").trim()),d.attackConditionals=n;break;case"skillconditional":var k=h.split(":")[1].trim(),S=h.split(":").slice(2).join(":").trim();i[k]?i[k].push(S):i[k]=[S],d.skillConditionals=i;break;case"unarmeddamage":t=h.split(":").slice(1).join(":").trim(),d.unarmedDamageString=t;break;case"attack":var C=h.split(":")[1].trim(),_=h.split(":").slice(2),x={Name:C};if(_.length%2){log("Could not parse attack: could not find a key for each value: "+h);continue}for(var b=0,p=_.length;b<p;b+=2){var y=_[b].trim().toLowerCase(),w=_[b+1].trim();"attack"==y&&(y="AB"),x[y[0].toUpperCase()+y.substring(1)]=w}s[C]=x,d.extraAttacks=s;break;default:log("Unable to parse: "+c)}}}return d}function quench(){$("#skills tr.skillslot td.name input").focus(function(e){var t=$(e.target).parent().siblings("td.char").find("input");t.attr("data-mong",t.is(":checked"))}),$("#skills tr.skillslot td.name input").blur(function(e){var t=$(e.target).parent().siblings("td.char").find("input");"true"==t.attr("data-mong")!=t.is(":checked")&&(t.prop("checked","true"==t.attr("data-mong")),saveSheetShit(t))}),$("#skills tr.skillslot td:nth-child(8) input").blur(function(){var e=0;$("#skills tr.skillslot td:nth-child(8) input").each(function(){parseInt($(this).val())&&(e+=parseInt($(this).val()))}),$("#totalranks").text(e)}),$("#skills tr.skillslot td:nth-child(8) input:first").blur()}function saveSheetShit(e){if($.isArray(e))for(var t in e)saveSheetShit(e[t]);else $(e)[0].dispatchEvent(new Event("change",{bubbles:!0,target:$(e)[0]}))}function highlightChanges(e){sheetCollectorHash||(sheetCollectorHash=loadVal("sheetCollectorHash",{})),sheetCollectorHash[e]||(sheetCollectorHash[e]={}),$("input:not(:hidden)[name]").add("textArea:not(:hidden)[name]").each(function(){sheetCollectorHash[e][$(this).attr("name")]&&sheetCollectorHash[e][$(this).attr("name")]!=$(this).val()&&(log("change detected in "+$(this).attr("name")+": was: "+sheetCollectorHash[e][$(this).attr("name")]+" now: "+$(this).val()),$(this).css("background-color","#eeeeff"),$(this).attr("title",$(this).attr("title")+"\nPreviously: "+sheetCollectorHash[e][$(this).attr("name")]+" on "+new Date(sheetCollectorHash[e].lastScrape).toLocaleString()))}).promise().done(function(){sheetCollectorHash[e].lastScrape=Date.now(),saveVal("sheetCollectorHash",sheetCollectorHash)})}function improveSheet(e,t){knownFeats||(knownFeats=loadVal("knownFeats",[])),knownGear||(knownGear=loadVal("knownGear",[])),knownSpells||(knownSpells=loadVal("knownSpells",[])),highlightChanges(t),$("#showToggles").append("<hr>Pin to a game: <select id='pin2game'><option>Select a game</option></select>"),$("#showToggles").append("<br/>Copy/paste all values: "+printFauxButton("copyAll","Copy","Copy as much of this sheet as possible")+printFauxButton("pasteAll","Paste","Paste whatever is currently copied")),$("#copyAll").click(function(){sheetCopyPasteHash||(sheetCopyPasteHash=loadVal("sheetCopyPasteHash",{})),$("input:not(:hidden)[name]").each(function(){sheetCopyPasteHash[$(this).attr("name")]=$(this).val()}).promise().done(function(){saveVal("sheetCopyPasteHash",sheetCopyPasteHash),putAnAlertSomewhere("Done!","#MWGoldCPToggles")})}),$("#pasteAll").click(function(){sheetCopyPasteHash||(sheetCopyPasteHash=loadVal("sheetCopyPasteHash",{})),$("input:not(:hidden)[name]").each(function(){sheetCopyPasteHash[$(this).attr("name")]&&($(this).val(sheetCopyPasteHash[$(this).attr("name")]),saveSheetShit(this))})}),sheetCollectorHash||(sheetCollectorHash=loadVal("sheetCollectorHash",{})),$("#showToggles").append("<br/>Restore last version: "),sheetCollectorHash[t]&&1==Object.keys(sheetCollectorHash[t]).length?$("#showToggles").append("Sheet was empty last time it was cached. Sorry =("):sheetCollectorHash[t]?($("#showToggles").append(printFauxButton("restoreOMG","Restore","Restore as much of this sheet as possible")),$("#restoreOMG").click(function(){log("known vals: "+Object.keys(sheetCollectorHash[t])),$("input:not(:hidden)[name]").add("textArea:not(:hidden)[name]").each(function(){sheetCollectorHash[t][$(this).attr("name")]&&(log("restoring "+$(this).attr("name")+" to: "+sheetCollectorHash[t][$(this).attr("name")]),$(this).val(sheetCollectorHash[t][$(this).attr("name")]),saveSheetShit($(this)))})})):$("#showToggles").append("No data found. Sorry =("),myGames||(myGames=loadVal("myGames","")),""==myGames&&getMyGames();for(var a in myGames)$("#pin2game").append('<option value="'+a+'">'+myGames[a].name+"</option>"),(myGames[a].pinnedNPCs[t]||myGames[a].pinnedPCs[t])&&$("#pin2game option:last").prop("selected","true");if($("#pin2game").change(function(){if("Select a game"!=$("#pin2game option:selected").text()){var e=$("#pin2game option:selected").val();$("#pin2game option:selected").text();myGames=loadVal("myGames",{}),sheetHash=loadVal("sheetHash",{}),Object.values(sheetHash).includes(t)?$("#character_other_notes").length>0?myGames[e].pinnedNPCs[t]=$("#sheet > div:nth-child(1) input[name=name]").val():myGames[e].pinnedNPCs[t]=$("#info input[name=Name]").val():$("#character_other_notes").length>0?myGames[e].pinnedPCs[t]=$("#sheet > div:nth-child(1) input[name=name]").val():myGames[e].pinnedPCs[t]=$("#info input[name=Name]").val(),$("#character_other_notes").length<1&&scrapeWithName(document,t,$("#info > tbody > tr:nth-child(1) > td:nth-child(1) > input[name=Name]").val()),saveVal("myGames",myGames)}}),$("#statblock tbody tr:first td:first").length>0&&($("#statblock tbody tr:first td:first").html(printFauxButton("statSumButton","Calculate","Opens a mini-window for tallying stats")),$("#statSumButton").addClass("smallfont btn btn-primary").click(function(){createPBDialog(!0)})),!($("#character_other_notes").length>0)){toggleHash["Show featstore"]?$("#sheet > div:nth-child(1)").css("height","1400px"):$("#sheet > div:nth-child(1)").css("height","1250px"),$("head title").html().includes("Pathfinder")?($("#sheet > div:nth-child(2)").css("height","1250px"),$("#sheet > div:nth-child(3)").css("height","750px")):$("#sheet > div:nth-child(3)").css("height","1300px"),$(window).scrollTop(loadVal("ScrollPos_"+t,$(window).scrollTop())),$("#totalweight").html(parseFloat(parseFloat($("#totalweight").html()).toFixed(2))),$("#gear tr.slot td:nth-child(2) input").blur(function(){$("#totalweight").html(parseFloat(parseFloat($("#totalweight").html()).toFixed(2)))}),toggleHash["Quench auto-crossclassing when skill name changes"]&&quench(),$("#gear tr:nth-child(1) > td").append(printFauxButton("swapItemCols","Swap","Swaps the contents of the weight & location columns")),$("#swapItemCols").css("color","black").css("float","right").click(function(){$("#gear tr.slot").each(function(){var e=$(this).find("td:nth-child(2) > input").val();$(this).find("td:nth-child(2) > input").val($(this).find("td:nth-child(3) > input").val()),$(this).find("td:nth-child(3) > input").val(e),saveSheetShit([$(this).find("td:nth-child(2) > input"),$(this).find("td:nth-child(3) > input")])})}),$("#currency").before('<table style="min-width:457px" class="spellssheets"><tbody id=backpackContainer><tr colspan="6" class="title"><td colspan="6">MWGold: Backpacks</td></tr></tbody></table>'),toggleHash["Show item backpacks"]||$("#backpackContainer").hide(),nonBoolSettings||(nonBoolSettings=loadVal("nonBoolSettings",nonBoolDefaults));for(var i=1,n="Global",o=nonBoolSettings["Number of item backpacks"];i<1+o.global+o.local;i++){i==1+o.global&&(n="");s=i;(l=loadVal("Backpackstore_"+(""!=n?n:t)+"_"+i,!1))?s=s+" ("+l.Name+"): "+(Object.keys(l).length-1)+" items":s+=": empty",i%2&&$("#backpackContainer").append('<tr colspan="6"></tr>'),$("#backpackContainer tr:last").append('<td colspan="2">'+(""!=n?n+" ":"")+s+'</td><td align="right" colspan="1">'+printFauxButton("backpackSave"+n+i,"Save","Save this list of items in slot "+i+(""!=n?" so that it can be accessed by other sheets":""))+printFauxButton("backpackLoad"+n+i,"Load","Load this list of items from slot "+i+(""!=n?" so that it can be accessed by other sheets":""))+printFauxButton("backpackForget"+n+i,"Forget","Clear this list of items from"+(""!=n?" "+n:"")+" slot "+i)+"</td>"),$("#backpackSave"+n+i).click(function(){var e="",a=parseInt($(this).attr("id").replace(/\D/g,""));a<o.global&&(e="Global");var i=backpackstore("Backpackstore_"+(""!=e?e:t)+"_"+a);i&&$("#backpackContainer tr:eq("+Math.ceil(a/2)+") td:eq("+2*(1-a%2)+")").html(e+" "+a+" ("+i.Name+"): "+(Object.keys(i).length-1)+" items")}),$("#backpackLoad"+n+i).click(function(){var e="",a=parseInt($(this).attr("id").replace(/\D/g,""));a<o.global&&(e="Global"),backpackpour("Backpackstore_"+(""!=e?e:t)+"_"+a,!0)}),$("#backpackForget"+n+i).click(function(){var e="",a=$(this).attr("id").replace(/\D/g,"");a<o.global&&(e="Global"),GM_deleteValue("Backpackstore_"+(""!=e?e:t)+"_"+a),GM_deleteValue("Backpackstore_"+(""!=e?e:t)+"_"+a+"_type"),$("#backpackContainer tr:eq("+Math.ceil(a/2)+") td:eq("+2*(1-a%2)+")").html(e+" "+a+": empty")})}$("#feats").after('<table style="width:100%" class="spellssheets"><tbody id=featContainer><tr colspan="8" class="title"><td colspan="8">MWGold: Featstore</td></tr><tr style="text-align:center" colspan="8" class="header"><td colspan="2">Column 1</td><td colspan="2">Column 2</td><td colspan="2">Column 3</td><td colspan="2">Column 4</td></tr></tbody></table>'),toggleHash["Show featstore"]||$("#featContainer").hide(),nonBoolSettings||(nonBoolSettings=loadVal("nonBoolSettings",nonBoolDefaults));for(var i=1,n="Global",o=nonBoolSettings["Number of feat columns"];i<o.global+o.local+1;i++){i==o.global+1&&(n="");s=i;(l=loadVal("Featstore_"+(""!=n?n:t)+"_"+i,!1))?s=s+" ("+l.Name+"): "+(Object.keys(l).length-1)+" feats":s+=": empty",1==i%4&&$("#featContainer").append('<tr colspan="8"></tr>'),$("#featContainer tr:last").append('<td colspan="1">'+(""!=n?n+" ":"")+s+'</td><td align="right" colspan="1">'+printFauxButton("featSave"+n+i,"Save","Save this list of feats in slot "+i+(""!=n?" so that it can be accessed by other sheets":""))+printFauxButton("featLoad"+n+i,"Load","Load this list of feats from slot "+i+(""!=n?" so that it can be accessed by other sheets":""))+printFauxButton("featForget"+n+i,"Forget","Clear this list of feats from"+(""!=n?" "+n:"")+" slot "+i)+"</td>"),$("#featSave"+n+i).click(function(){var e="",a=parseInt($(this).attr("id").replace(/\D/g,""));a<=nonBoolSettings["Number of feat columns"].global&&(e="Global");var i=featstore("Featstore_"+(""!=e?e:t)+"_"+a,(a-1)%4);i&&$("#featContainer tr:eq("+(Math.floor((a-1)/4)+2)+") td:eq("+(a-1)%4*2+")").html(e+" "+a+" ("+i.Name+"): "+(Object.keys(i).length-1)+" feats")}),$("#featLoad"+n+i).click(function(){var e="",a=parseInt($(this).attr("id").replace(/\D/g,""));a<=nonBoolSettings["Number of feat columns"].global&&(e="Global"),featpour("Featstore_"+(""!=e?e:t)+"_"+a,!0,(a-1)%4)}),$("#featForget"+n+i).click(function(){var e="",a=$(this).attr("id").replace(/\D/g,"");a<nonBoolSettings["Number of feat columns"].global&&(e="Global"),GM_deleteValue("Featstore_"+(""!=e?e:t)+"_"+a),GM_deleteValue("Featstore_"+(""!=e?e:t)+"_"+a+"_type"),$("#featContainer tr:eq("+(Math.floor((a-1)/4)+2)+") td:eq("+(a-1)%4*2+")").html(e+" "+a+": empty")})}$("#spellstuff td:first").prepend('<table style="min-width:230px" cellspacing="0" class="spellssheets"><tbody id=spellControlsContainer><tr colspan="4" class="title"><td colspan="4">MWGold: Spell sheets</td></tr></tbody></table>'),toggleHash["Show spell sheets"]||$("#spellControlsContainer").hide();for(i=1;i<1+nonBoolSettings["Number of spell sheets"].global;i++){s=i;(l=loadVal("Spellstore_global_"+i,!1))?s=s+" ("+l.Name+"): "+(Object.keys(l).length-1)+" spells":s+=": empty",$("#spellControlsContainer").append('<tr colspan="4"><td colspan="3">Global '+s+'</td><td align="right" colspan="1">'+printFauxButton("spellbookSaveGlobal"+i,"Save","Save this list of spells in slot "+i+" so that it can be accessed by other sheets")+printFauxButton("spellbookLoadGlobal"+i,"Load","Load this list of spells from slot "+i+" so that it can be accessed by other sheets")+printFauxButton("spellbookForgetGlobal"+i,"Forget","Clear this list of spells from global slot "+i)+"</td></tr>"),$("#spellbookSaveGlobal"+i).click(function(){var e=parseInt($(this).attr("id").replace(/\D/g,"")),t=spellstore("Spellstore_global_"+e);t&&$("#spellControlsContainer tr:eq("+e+") td:first").html("Global "+e+" ("+t.Name+"): "+(Object.keys(t).length-1)+" spells")}),$("#spellbookLoadGlobal"+i).click(function(){spellpour("Spellstore_global_"+$(this).attr("id").replace(/\D/g,""),!0)}),$("#spellbookForgetGlobal"+i).click(function(){var e=$(this).attr("id").replace(/\D/g,"");GM_deleteValue("Spellstore_global_"+e),GM_deleteValue("Spellstore_global_"+e+"_type"),$("#spellControlsContainer tr:eq("+e+") td:first").html("Global "+e+": empty")})}for(i=1;i<1+nonBoolSettings["Number of spell sheets"].local;i++){var s=i,l=loadVal("Spellstore_"+t+"_"+i,!1);l?s=s+" ("+l.Name+"): "+(Object.keys(l).length-1)+" spells":s+=": empty",$("#spellControlsContainer").append('<tr colspan="4"><td colspan="3">'+s+'</td><td align="right" colspan="1">'+printFauxButton("spellbookSave"+i,"Save","Save this list of spells in slot "+i)+printFauxButton("spellbookLoad"+i,"Load","Load this list of spells from slot "+i)+printFauxButton("spellbookForget"+i,"Forget","Clear this list of spells from slot "+i)+"</td></tr>"),$("#spellbookSave"+i).click(function(){var e=parseInt($(this).attr("id").replace(/\D/g,"")),a=spellstore("Spellstore_"+t+"_"+e);a&&$("#spellControlsContainer tr:eq("+(e+2)+") td:first").html(e+" ("+a.Name+"): "+(Object.keys(a).length-1)+" spells")}),$("#spellbookLoad"+i).click(function(){spellpour("Spellstore_"+t+"_"+$(this).attr("id").replace(/\D/g,""),!0)}),$("#spellbookForget"+i).click(function(){var e=parseInt($(this).attr("id").replace(/\D/g,""));GM_deleteValue("Spellstore_"+t+"_"+e),GM_deleteValue("Spellstore_"+t+"_"+e+"_type"),$("#spellControlsContainer tr:eq("+(e+2)+") td:first").html(e+": empty")})}$("#spellControlsContainer").append("<tr></tr>"),$('a[title="Sort by Number of times cast, memorized, or manifested"]').html("#Mem"),$("table.spelllist").parent().css("padding-right","10px"),$("table.spelllist td.name").each(function(){var e=$(this).find("input").attr("name");$(this).parent().append(printFauxButton(e+"spacer","+","Insert blank line")),$(this).parent().append(printFauxButton(e+"killer","-","Remove this line")),$("#"+e+"killer").addClass("spellspacer").css("display","inline").hide().click(function(){for(var e=$(this).parent().index(),t=$(this).parents("table.spelllist").find("tr:last"),a=$(t).index(),i="",n="";a>=e;a--){var o=$(t).find("td.name input").val(),s=$(t).find("td.mem input").val();i==o&&s==n||($(t).find("td.name input").val(i),$(t).find("td.mem input").val(n),i=o,n=s,saveSheetShit([$(t).find("td.name input"),$(t).find("td.mem input")])),t=$(t).prev()}}),$("#"+e+"spacer").addClass("spellspacer").css("display","inline").hide().click(function(){for(var e=$(this).parent().index()+1,t=$(this).parents("table.spelllist").find("tr:nth-child("+e+")"),a=$(t).siblings("tr").length,i=e,n="",o="";i<=a;i++){var s=$(t).find("td.name input").val(),l=$(t).find("td.mem input").val();n==s&&l==o||($(t).find("td.name input").val(n).change(),$(t).find("td.mem input").val(o).change(),n=s,o=l,saveSheetShit([$(t).find("td.name input"),$(t).find("td.mem input")])),t=$(t).next()}}),$(this).parent().hover(function(){$("#"+e+"spacer").show(),$("#"+e+"killer").show()},function(){$(".spellspacer").hide()})}),toggleHash["Show item suggestions"]&&($("input.name[name*='Gear']").autocomplete({minLength:3,source:knownGear,position:{collision:"flip"},focus:function(e,t){return $(this).val(t.item.label),!1},select:function(e,t){return $(this).val(t.item.label),t.item.weight&&!toggleHash["Use weight column for item costs"]&&$("input[title="+$(this).attr("name")+"W]").val(t.item.weight),t.item.cost&&toggleHash["Tally gold spent in Currency box"]&&$("textarea[title=Cash]").val($("textarea[title=Cash]").val()+"\n-"+t.item.cost+"gp ("+t.item.label+")"),t.item.cost&&toggleHash["Use weight column for item costs"]&&$("input[title="+$(this).attr("name")+"W]").val(t.item.cost),!1}}).autocomplete("instance")._renderItem=function(e,t){return $("<li class='smallfont'>").append("<div>"+t.label+"</div>").appendTo(e)}),toggleHash["Show feat suggestions"]&&($("input[name*='Feat']").autocomplete({minLength:3,source:knownFeats,position:{collision:"flip"}}).autocomplete("instance")._renderItem=function(e,t){return $("<li class='smallfont'>").append("<div style='word-wrap:normal'>"+t+"</div>").appendTo(e)}),toggleHash["Show spell suggestions"]&&$("td.name input[name*='Spell']").autocomplete({minLength:4,source:knownSpells,position:{collision:"flip"}})}}function backpackstore(e){var t=prompt("What would you like to call this backpack?");if(!t)return!1;var a={Name:t};return $("#gear tr.slot td:nth-child(1) input").each(function(){var e=$(this).attr("name"),t=$(this).val(),i=$(this).parent().next().find("input").val(),n=$(this).parent().next().next().find("input").val();(t||i||n)&&(""==t&&""==i&&""==n||(a[e]=[t,i,n]))}),saveVal(e,a),a}function backpackpour(e,t){var a=loadVal(e,{});$("#gear tr.slot td:nth-child(1) input").each(function(){var e=$(this).attr("name"),i=$(this).parent().next().find("input"),n=$(this).parent().next().next().find("input");if(!a[e]){if(!t)return;a[e]=["","",""]}a[e][0]==$(this).val()&&i.val()==a[e][1]&&n.val()==a[e][2]||($(this).val(a[e][0]),i.val(a[e][1]),n.val(a[e][2]),saveSheetShit([i,n,this]))})}function spellstore(e){var t=prompt("What would you like to call this spellbook sheet?");if(!t)return!1;var a={Name:t};return $(".spelllist td.name input").each(function(){var e=$(this).attr("name"),t=$(this).val(),i=$(this).parent().siblings("td.mem").find("input").val();(t||i)&&(""==t&&""==i||(a[e]=[t,i]))}),saveVal(e,a),a}function spellpour(e,t){var a=loadVal(e,{});$(".spelllist td.name input").each(function(){var e=$(this).attr("name"),i=$(this).parent().siblings("td.mem").find("input");if(!a[e]){if(!t)return;a[e]=["",""]}a[e][0]==$(this).val()&&i.val()==a[e][1]||($(this).val(a[e][0]),i.val(a[e][1]),saveSheetShit([i,this]))})}function featstore(e,t){var a=prompt("What would you like to call this feat column?");if(!a)return!1;var i={Name:a},n=0;return $("#feats > tbody > tr:nth-child(2) > td:eq("+t+")").find("input").each(function(){var e=$(this).val();e&&""!=e&&(i[n++]=e)}),saveVal(e,i),i}function featpour(e,t,a){var i=loadVal(e,{}),n=0;$("#feats > tbody > tr:nth-child(2) > td:eq("+a+")").find("input").each(function(){if(!i[n]){if(!t)return n++;i[n]=""}if(i[n]==$(this).val())return n++;$(this).val(i[n++]),saveSheetShit(this)})}function waitForFire(e,t,a){$("#progress").length>0&&($("#progress").val(25),$("#progressText").html("Waiting on sheet..."));var i=new MutationObserver(function(n){$("#progress").length>0&&($("#progress").val(50),$("#progressText").html("Waiting on sheet data...")),($(t).find("#character_other_notes textarea[name]").length>0&&$(t).find("input[name=name]").val()||$(t).find("textarea[title=Notes]").length>0&&($(t).find("textarea[title=Notes]").val()||$(t).find("input[name=Name]").val()))&&(log("firing: "+e.toString().split("{")[0]),$("#progress").length>0&&($("#progress").val(75),$("#progressText").html("Scraping sheet...")),e(t,a),$("#progress").length>0&&($("#progress").val(90),$("#progressText").html("Dumping sheet...")),i.disconnect())});i.observe(t===document?$("body")[0]:t.body,{childList:!0})}function cleanArray(e){for(var t=new Array,a=0;a<e.length;a++)e[a]&&0!=e[a].length&&t.push(e[a]);return t}function saveVal(e,t){switch(typeof t){case"undefined":log("setting undefined value to key:"+e);break;case"boolean":case"string":case"number":GM_setValue(e,t),GM_setValue(e+"_type",typeof t);break;case"object":GM_setValue(e,JSON.stringify(t)),GM_setValue(e+"_type",typeof t);break;default:log("setting unknown value ("+value+") to key:"+e)}}function loadVal(e,t){var a=t,i=GM_getValue(e+"_type",null);if(null==i)return t;switch(i){case"undefined":log("found undefined value for key:"+e);break;case"boolean":case"string":case"number":a=GM_getValue(e,t);break;case"object":a=JSON.parse(GM_getValue(e,JSON.stringify(t)));break;default:log("found peculiar value for key:"+e)}return a}function printFauxButton(e,t,a){return"<div class='smalltext' title='"+a+"' style='"+fauxButton+"' id='"+e+"'>"+t+"</div>"}function getSelection(e){var t=$("#"+e)[0].selectionStart,a=$("#"+e)[0].selectionEnd;return log("found selection '"+$("#"+e).val().substr(t,a-t)+"'"),$("#"+e).val().substr(t,a-t)}function putAnAlertSomewhere(e,t){$("#tempDiv").remove(),$(t).append("<div id='tempDiv'>"+e+"</div>"),$("#tempDiv").fadeOut(3e3).promise().done(function(){$(this).remove()})}function insertAtCaret(e,t){var a=document.getElementById(e);if(a){var i=a.scrollTop,n=a.selectionStart,o=a.value.substring(0,n),s=a.value.substring(n,a.value.length);a.value=o+t+s,n+=t.length,a.selectionStart=n,a.selectionEnd=n,a.focus(),a.scrollTop=i}}function overwrite(e,t){var a=document.getElementById(e);if(a){var i=a.scrollTop,n=a.selectionStart,o=a.selectionEnd;if(n!=o){var s=a.value.substring(0,n),l=a.value.substring(o,a.value.length);a.value=s+t+l,o=n+t.length,a.selectionStart=n,a.selectionEnd=o,a.focus(),a.scrollTop=i}else insertAtCaret(e,t)}}function getErrorObject(){try{throw Error("")}catch(e){return e}}function getLineNumber(){return getErrorObject().stack.split("\n")[3].replace(/.*:(\d+:\d+)$/,"$1")}function log(e){debugMode&&(null==log.caller?console.log("main@"+getLineNumber()+": "+e):console.log(log.caller.name+"@"+getLineNumber()+": "+e))}function makeAwesome(){if($("head").append('<link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.12.1/themes/pepper-grinder/jquery-ui.css">'),$("head").append("<style>.subbed{background:#eeeeee;background-position: center; background-repeat: no-repeat;}  .codeline {font-family:Georgia, Times, serif;color:purple}</style>"),toggleHash||(toggleHash=loadVal("toggleHash",toggleDefaults)),Object.keys(toggleHash).length<Object.keys(toggleDefaults).length&&(toggleHash=toggleDefaults),siteIs("sheetURL")){var e=document.URL.replace(/\D/g,"");$("button.sheetsave").click(function(){scrape(document,e)}),$("head").append("<style>.page {padding: 5px} .page table {border-spacing:0px;} .recentlyChanged{background-color: #dfedf9}.ui-autocomplete {overflow-x: hidden;overflow-y: auto;max-height:500px;max-width:300px} .spellssheets tr.title td {background-color:black; color:white; font-size:14px; font-weight:bold; font-family:Arial, sans-serif; text-align:center}.spellssheets td:first {text-align:center;border:1px solid black;width:100%}.spellspacer{max-height:8px; white-space: nowrap; }</style>"),waitForFire(improveSheet,document,e),toggleHash["Auto-load sheet on visit"]&&waitForFire(scrape,document,e),$("#sheet_controls .mwadcontainer").remove(),$("#alerts").prev("div").has("a[href*=facebook]").remove(),$("#character_name").parent().after("<li id='MWGoldCPToggles'>"+printFauxButton("openConfig","Configurate","Show the MW Gold configuration options")+"<br/><div class='alt2' id='showToggles' hidden></div></li>"),$("#openConfig").addClass("btn btn-primary").css("margin-top","0.8em").click(function(){$("#showToggles").toggle()});var t=sheetToggleList;for(var a in t){n="<input id='MWGoldToggle"+a+"' data-key='"+t[a]+"' type='checkbox' "+(toggleHash[t[a]]?"checked":"")+"/><a title='"+t[a]+"' class='smallfont'>"+(t[a].length>38?t[a].substr(0,35)+"...":t[a])+"</a><br />";$("#showToggles").append(n),$("#MWGoldToggle"+a).change(function(e){toggleHash[$("#"+e.target.id).attr("data-key")]=$("#"+e.target.id).is(":checked"),saveVal("toggleHash",toggleHash),putAnAlertSomewhere("Changes saved","#MWGoldCPToggles"),"Quench auto-crossclassing when skill name changes"==$("#"+e.target.id).attr("data-key")&&$("#"+e.target.id).is(":checked")&&quench(),"Show featstore"==$("#"+e.target.id).attr("data-key")&&($("#featContainer").toggle(),"1400px"==$("#sheet > div:nth-child(1)").css("height")?$("#sheet > div:nth-child(1)").css("height","1250px"):$("#sheet > div:nth-child(1)").css("height","1400px")),"Show item backpacks"==$("#"+e.target.id).attr("data-key")&&$("#backpackContainer").toggle(),"Show spell sheets"==$("#"+e.target.id).attr("data-key")&&$("#spellControlsContainer").toggle()})}$(window).click(function(){saveVal("ScrollPos_"+e,$(window).scrollTop())})}else{if($('a[title="Your Profile"]').length>0?(uNum=$('a[title="Your Profile"]').attr("href").toString().split("?")[1],uName=$('a[title="Your Profile"]').html(),$("#timenow").children().attr("title","Page loaded: "+$("#timenow").children().html()+", "+$("#timenow").children().attr("title")),(sheetHash=loadVal("sheetHash",null))||getListofSheets(!1),analysisHash||(analysisHash=loadVal("analysisHash",{}))):log("Error: Could not find profile button"),siteIs("userCPURL")){notifyInUserCPButton($("#threadslist").parent()),$("td.tcat:first").attr("id","MWGoldCP").css("max-width","168px").css("background-size","cover").html("").parents("table.tborder tbody").children(":gt(0)").addClass("junk").hide(),$("#MWGoldCP").append("<fieldset id='MWGoldCPToggles'><legend style='color: #ffffcc'>MW Gold: Options</legend><div class='alt2' id='showToggles'></div><center><button id='showTheToggles' title='Display display options' class='button'>Show show options</button></center><div class='alt2' id='showTogglesList' hidden></div></fieldset>").parent().before("<tr><td class='button' id='showJunk'><center>Show regular shite</center></td></tr>"),$("#showJunk").click(function(){$("#MWGoldCP").is(":hidden")?($("#MWGoldCP").toggle(),$(".junk").toggle(),$("#showJunk").html("<center>Show regular shite</center>")):($("#MWGoldCP").toggle(),$(".junk").toggle(),$("#showJunk").html("<center>Show Gold control panel</center>"))}),$("#showTheToggles").css("max-width","100%").css("color","black");for(var i in toggleHash)if(!i.startsWith("Widescreen")&&!sheetToggleList.includes(i)){var n="<input id='MWGold"+i.replace(/[^a-z]/gi,"")+"' data-key='"+i+"' type='checkbox' "+(toggleHash[i]?"checked":"")+"/><a title='"+i+"' style='color: #ffffcc' class='smallfont'>"+(i.length>23?i.substr(0,20)+"...":i)+"</a><br />";i.startsWith("Show ")?$("#showTogglesList").append(n):$("#showToggles").before(n),$("#MWGold"+i.replace(/[^a-z]/gi,"")).change(function(e){toggleHash[$("#"+e.target.id).attr("data-key")]=$("#"+e.target.id).is(":checked"),saveVal("toggleHash",toggleHash),putAnAlertSomewhere("Changes saved<br/>Refresh to see them","#MWGoldCPToggles")})}var o=loadVal("newMessageURL",defaultNewMessageURL),s=o.split("/").slice(-1)[0];if(s&&""!=s||(s=o),$("#MWGoldAudionotifywhennewmessagesarereceived").next().after("<br/>Notification sound:<br/><a id='changeSound'>"+(s.length>23?s.substr(0,20)+"...":s)+"</a>"),$("#changeSound").click(function(){$("#newSound").length>0||($("#changeSound").html("<input type='textbox' id='newSound' value='"+o+"'/>"),$("#newSound").keypress(function(e){if(13==e.keyCode)return $(this).blur(),!1}),$("#newSound").blur(function(){(o=$(this).val())&&""!=o||(o=defaultNewMessageURL),saveVal("newMessageURL",o);var e=o.split("/").slice(-1)[0];$("#changeSound").html(e.length>23?e.substr(0,20)+"...":e),$(this).remove()}))}),$("#showTheToggles").click(function(){$("#showTogglesList").is(":hidden")?($("#showTogglesList").slideDown(),$("#showTheToggles").html("No show show options")):($("#showTogglesList").slideUp(),$("#showTheToggles").html("Show show options"))}),printPinnedThreads(),$("#MWGoldCP").append("<hr /><input id='MWGoldWidescreen' data-key='Widescreen' type='checkbox' "+(toggleHash.Widescreen||toggleHash.WidescreenPortal?"checked":"")+"/><a title='Enable widescreen on Myth-Weavers' style='color: #ffffcc' class='smallfont'>Enable Widescreen</a><br /><div id='widescreenBiz' "+(toggleHash.Widescreen||toggleHash.WidescreenPortal?"":"hidden")+"><input id='MWGoldWidescreenPortal' data-key='WidescreenPortal' type='checkbox' "+(toggleHash.WidescreenPortal&&!toggleHash.Widescreen?"checked":"")+"/><a title='Only enable widescreen on the Myth-Weavers portal/main page' style='color: #ffffcc' class='smallfont'>Only on portal</a><br />Widescreen %: <input type='textarea' style='width:30px' id='widthVal' title='Type a whole number between 1 and 100' value='"+loadVal("width",90)+"' /></div><hr/><center><button id='showForgetStuff' title='Display display options' class='button'>Show buttons of forgetting</button></center><br class='stuff' /><button class='stuff' title='Currently have: "+(sheetHash?Object.keys(sheetHash).length:0)+" characters' id='rescrapeSheets'>Refresh character list</button><br class='stuff' /><button class='stuff' title='Forget all analysis data' id='forgetAnalyses'>Forget analyses</button><br class='stuff' /><button class='stuff' title='CAUTION: Will forget everything! Analyses, loaded sheets, stored spell lists and backpacks, recorded images, saved templates, preferences - everything!' id='totalAmnesia'>Forget all data</button>"),$("#showForgetStuff").click(function(){$(".stuff").slideToggle()}),$("#MWGoldWidescreen").change(function(e){var t=$("#"+e.target.id).is(":checked");toggleHash.Widescreen=t&&!$("#MWGoldWidescreenPortal").is(":checked"),t||(toggleHash.WidescreenPortal=!1),saveVal("toggleHash",toggleHash),t?$("#widescreenBiz").slideDown():$("#widescreenBiz").slideUp()}),$("#MWGoldWidescreenPortal").change(function(e){var t=$("#"+e.target.id).is(":checked");toggleHash.Widescreen=!t,toggleHash.WidescreenPortal=!0,saveVal("toggleHash",toggleHash)}),$("#widthVal").blur(function(){var e=parseInt($("#widthVal").val());isNaN(e)||e>100||e<0?putAnAlertSomewhere("Invalid width","#widescreenBiz"):(saveVal("width",e),toggleHash.Widescreen&&widescreen(e))}),$("#rescrapeSheets").click(function(){getListofSheets(!0)}),$("#totalAmnesia").click(amnesia),$("#forgetAnalyses").click(forgetAnalyses),toggleHash["Show site-wide templates"]&&(sitewideHash||(sitewideHash=loadVal("sitewideHash",{})),Object.keys(sitewideHash).length>0&&(putInWideButtonFieldset("Site-wide templates",sitewideHash,"MWGoldSitewide","MWGoldCPDeleteSitewides",null),$("#MWGoldCPDeleteSitewides").addClass("stuff"))),loadedSheets||(loadedSheets=loadVal("loadedSheets",null)),loadedSheets){$("#MWGoldCP").append("<fieldset class='stuff' id='loadedSheets'><legend style='color: #ffffcc'>Loaded characters</legend></fieldset>");for(var l in loadedSheets){var r=l;r.length>9&&(r=l.substr(0,6)+"..."),$("#loadedSheets").append(printFauxButton("sheet"+loadedSheets[l],"Forget "+r,l.replace(/'/,"`")+'\nWill forget all memory of this sheet (will NOT delete the sheet itself; you will just need to click the "Load to MW" button on the sheet again)')+"<br/>"),$("#sheet"+loadedSheets[l]).css("color","#000000").attr("data-name",l).click(function(){var e=$(this).attr("data-name");delete loadedSheets[e],saveVal("loadedSheets",loadedSheets),$(this).remove()})}}$(".stuff").toggle(),subscribedForumLinks=[],$('#collapseobj_usercp_forums > tr[align!="center"] > td:nth-child(2) > a[href*="'+knownURLS.forumDisplayURL+'"]').each(function(){subscribedForumLinks.push($(this).attr("href").replace(/^\/\//,"https://"))}),getAllPeeps()}else if(siteIs("showThreadURL")){addEditorButtons("vB_Editor_QR_textarea","vB_Editor_QR");var d=getThreadID(),p=loadVal("mutedColours",{});subbedThreads||(subbedThreads=loadVal("subbedThreads",[])),subbedThreads.length<1?$.get("https://www.myth-weavers.com/subscription.php?do=viewsubscription&folderid=all&pp=200",function(e){$(e).find("#threadslist li").each(function(){subbedThreads.push($(this).find("div[id]").attr("id").replace(/^\D+/g,""))}).promise().done(function(){saveVal("subbedThreads",subbedThreads)})}):subbedThreads.includes(d)&&$('ul.buttonbar > li > a[href*="subscription.php"]').addClass("subbed"),$('ul.buttonbar > li > a[href*="subscription.php"]').attr("href","javascript:void(0)").click(function(){subToThread(getThreadID()),$(this).addClass("subbed")}),toggleHash["Hide signatures"]&&($(".signature").hide(),$(".signature:parent").prev("div.postFooterRule").css("margin-right","180px"),$(".signature:parent").prev().prev().prepend("<a href='javascript:void(0)'>Sig</a>"),$(".signature:parent").prev().prev().children("a:nth-child(1)").click(function(){$(this).parent().next().next().toggle()})),$("#posts > div").each(function(){var e=$(this).find("div.userMenu ul li a.bigusername").text();$(this).find("div.postControlsTop").prepend('<a href="javascript: void(0)" class="GoldPostControlsController" style="min-width:15px;min-height:15px; background-repeat:no-repeat;background-image:url(http://i.imgur.com/TxZ3RPe.png)"></a>'),$(this).find("div.postControlsTop").prepend('<a href="javascript: void(0)" class="filterByPoster GoldPostControls" hidden data-poster="'+e+'" title="Show only this person\'s posts">Only</a>'),$(this).find("div.postControlsTop").prepend('<a href="javascript: void(0)" class="hidePoster GoldPostControls" hidden data-poster="'+e+'" title="Hide this person\'s posts">Exclude</a>'),$(this).find("div.postControlsTop").prepend('<a href="javascript: void(0)" class="showAll GoldPostControls" hidden title="Show all posts">All</a>'),$(this).find("div.postControlsTop").prepend('<a href="javascript: void(0)" class="decolourify GoldPostControls" hidden title="Blacken coloured text from this post">Decolourify</a>')}),$("a.GoldPostControlsController").click(function(){$(this).siblings("a.GoldPostControls").slideToggle()}),$("a.decolourify").click(function(){var e=$(this).parents("div.postHeader").siblings("div.postContent").find("font[color]"),t={},a=prompt("What would you like the replacement colour to be?","black");e.each(function(){t[$(this).attr("color")]=a}),e.attr("color",a);for(var i in t)p[i]=a;saveVal("mutedColours",p)}),$("font[color]").each(function(){p[$(this).attr("color")]&&$(this).attr("color",p[$(this).attr("color")])}),$("a.showAll").click(function(){$("#posts > div").show()}),$("a.hidePoster").click(function(){var e=$(this).attr("data-poster");$("#posts > div").each(function(){$(this).find("div.userMenu ul li a.bigusername").text()==e&&$(this).hide()})}),$("a.filterByPoster").click(function(){var e=$(this).attr("data-poster");$("#posts > div").each(function(){$(this).hide(),$(this).find("div.userMenu ul li a.bigusername").text()==e&&$(this).show()})}),toggleHash["Show footer"]&&$('img[src="https://static.myth-weavers.com/images/sonata2/social_fb.png"]:last').parents("div").fadeOut().prev().html("<span style='width:100%'></span>"),toggleHash["Show past thread analyses"]&&printThreadAnalysis(d),$("ul.buttonbar:first").prepend('<li><a id="Analyse'+d+'" data-thread-id="'+d+'" style="background-image: url(http://i.imgur.com/HUJwQHf.jpg)" title="Analyse Posting Stats"></a></li>'),$("#Analyse"+d).click(analyseThread),!toggleHash["Auto-analyse thread on thread visit"]||analysisHash.Threads&&analysisHash.Threads[d]||analyseThread()}else if(siteIs("newReplyURL"))addEditorButtons("vB_Editor_001_textarea","vB_Editor_001");else if(siteIs("editPostURL"))addEditorButtons("vB_Editor_001_textarea","vB_Editor_001");else if(siteIs("newThreadURL"))addEditorButtons("vB_Editor_001_textarea","vB_Editor_001");else if(siteIs("forumDisplayURL")){refreshThisStuff.push("#inlinemodform","div.col:nth-child(10)");var h=$("#gameprofileuri").attr("href");$("#gameprofileuri").hide(),$("#fd_game_links").prepend("<a id='loadGameForum'>Game Forum</a>"),$("#fd_game_links").prepend("<a id='loadGameProfile'>Game Profile</a>"),$("#inlinemodform").addClass("subform");var c=$(location).attr("href").split("=")[1];if($('#fd_game_links a[href*="www.myth-weavers.com/gmscreen.php?g="]').length>0){$('#fd_game_links a[href*="www.myth-weavers.com/gmscreen.php?g="]').hide(),$('#fd_game_links a[href*="do=editinfo"]').hide();var u=$('#fd_game_links a[href*="www.myth-weavers.com/gmscreen.php?g="]').attr("href"),f=$('#fd_game_links a[href*="do=editinfo"]').attr("href");$("#loadGameForum").after('<a id="loadEditGame">Edit Game</a>'),$("#loadGameForum").after('<a id="loadGMScreen">GM Screen</a>'),$("#loadEditGame").click(function(){makeTabbable(f,"editGameForm","#inlinemodform")}),$("#loadGMScreen").click(function(){makeTabbable(u,"GMScreenForm","#inlinemodform")}),myGames||(myGames=loadVal("myGames",{})),myGames[c]||(myGames[c]={name:$("#fd_game_links").next().find("h1:first").text(),pinnedPCs:{},pinnedNPCs:{}})}if($("#loadGameForum").click(function(){$(".subform").hide(),$("#inlinemodform").show()}),$("#loadGameProfile").click(function(){makeTabbable(h,"gameProfileForm","#inlinemodform")}),c&&toggleHash["Show game-wide templates"]){$("#threadgroups").after("<br style='height:7px'/><div id='MWGoldCP'></div>"),gamewideHash||(gamewideHash=loadVal("gamewideHash",{})),gamewideHash[c]&&Object.keys(gamewideHash[c]).length>0&&putInWideButtonFieldset("This game's templates",gamewideHash,"MWGoldGamewide","MWGoldCPDeleteGamewides",c),$("#MWGoldCP").append("Currently selected sheet:<select style='max-width:100%' id='MWGoldSheetSelector'></select>"),$("#MWGoldSheetSelector").append("<option>None</option>"),sheetHash||(sheetHash=GM_getValue("sheetHash",null)),sheetHash||getListofSheets(!1);var g=Object.keys(sheetHash);for(var m in g)$("#MWGoldSheetSelector").append("<option>"+g[m]+"</option>");curByGame||(curByGame=loadVal("curByGame",{})),curByGame[c]&&$("#MWGoldSheetSelector").val(curByGame[c]),$("#MWGoldSheetSelector").change(function(){curByGame||(curByGame=loadVal("curByGame",{})),curByGame[c]=$("#MWGoldSheetSelector").val(),saveVal("curByGame",curByGame)})}}else if(siteIs("memberURL")){var v=$(location).attr("href").split("=")[1];$("#minicontact").parent().append("<li id='analyseUser' class='thread'><a href='javascript:void(0)'>Analyse</a></li>"),$("#analyseUser").click(function(){analyseUser(v)}),printAnalForUser("#collapseobj_stats > div",v)}else if(siteIs("portalURL")){if(refreshThisStuff.push("#collapseobj_forumhome_activeusers"),subscribedForumLinks=[],$('img[src*="static.myth-weavers.com/images/sonata/statusicon/subforum_"]').siblings("a").each(function(){subscribedForumLinks.push($(this).attr("href").replace(/^\/\//,"https://"))}),log("subscribed to these games: "+JSON.stringify(subscribedForumLinks)),toggleHash["Rearrange front page"]){rearrangePortal(document),toggleHash.WidescreenPortal&&widescreen(90),$("#breadcrumb").html('<span id="MWGoldTopContainer" class="thead" style="color: #ffffcc;padding:3px"><span style="padding-right: 7px;padding-left: 17px;">Drag and resize the categories until they look pretty:  </span></span>'),$("#MWGoldTopContainer").append(printFauxButton("resetArrange","Reset","Reset size and position of all front page stuff")),$("#resetArrange").css("color","black").click(function(){selectiveAmnesia("pos_"),selectiveAmnesia("size_"),rearrangeEntry()}),$("#MWGoldTopContainer").append('<input type="checkbox" id="resizeStuff">Show resize things</input>'),$("#breadcrumb").append(printFauxButton("MWGoldOpenCloseTop","<","Hide the resize controls")),$("#MWGoldOpenCloseTop").click(function(){$("#MWGoldTopContainer").toggle("slide"),"<"==$("#MWGoldOpenCloseTop").text()?$("#MWGoldOpenCloseTop").text(">").attr("title","Show the resize controls"):$("#MWGoldOpenCloseTop").text("<").attr("title","Hide the resize controls")}),toggleHash["Show resize controls on front page"]||$("#MWGoldOpenCloseTop").click(),$("#resizeStuff").change(function(){$("#resizeStuff").is(":checked")?($("#forumhome_forumlist > li").each(function(){$(this).attr("class","col span-1 ui-widget-content").resizable({stop:function(e,t){log("entry for "+e.target.id),saveVal("size_"+e.target.id,{width:$("#"+e.target.id).css("width"),height:$("#"+e.target.id).css("height")})}}).css("background","transparent")}),$("#forumhome_forumlist").attr("class","col span-1 ui-widget-content").resizable({stop:function(e,t){log("entry for "+e.target.id),saveVal("size_"+e.target.id,{width:$("#"+e.target.id).css("width"),height:$("#"+e.target.id).css("height")})}}).css("background","transparent")):($("#forumhome_forumlist > li").each(function(){$(this).attr("class","col span-1").resizable("destroy")}),$("#forumhome_forumlist").removeClass("ui-widget-content").resizable("destroy"))});var b=loadVal("size_forumhome_forumlist",{height:"300px",width:"100%"});$("#forumhome_forumlist").css("height",b.height).css("width",b.width)}getAllPeeps(),$("div.col:last").remove(),$("thead").remove()}else if(siteIs("sheetListURL")){if($("table.table-striped").length>0){$("table.table-striped:first").attr("id","theTable").parent().attr("class","col-md-10 col-md-push-2"),$("#theTable").parent().next().next().remove(),$("#theTable").parent().next().attr("class","col-md-2 col-md-pull-10");var y=2;$("#theTable thead tr th:not(:last)").each(function(){""!=$(this).html().trim()&&($(this).append("<input style='float:right;max-width:50%' data-id='"+y+++"' type='textbox' />"),$(this).find("input").keypress(function(e){13==e.keyCode&&$(this).blur()}),$(this).find("input").blur(function(){var e=$(this).val(),t=parseInt($(this).attr("data-id")),a={};if($(this).parentsUntil("thead").find("th input").each(function(){""!=$(this).val()&&(a[$(this).attr("data-id")]=$(this).val())}),log("key: "+e+" & id: "+t),log("search terms: "+JSON.stringify(a)),Object.keys(a).length<1&&""==e)return $("#theTable tbody").find("tr").each(function(){$(this).show()}),void log("cleared filters");$("#theTable tbody").find("tr:visible").each(function(){$(this).attr("match","false")});var i=$("#theTable tbody").find("td:nth-child("+t+"):CoNTains("+e+")");i.length>0&&i.each(function(){$(this).parent().attr("match","true")}),$("#theTable tbody").find("tr").each(function(){"true"!=$(this).attr("match")&&$(this).hide()})}))}),$("#theTable tbody tr").each(function(){var e=$(this).children(":nth-child(1)").children("a").attr("href").split("/")[2];$(this).children("td:last").append('<img width="20px" href="#" src="https://cdn1.iconfinder.com/data/icons/basic-ui-elements-color/700/010_trash-2-128.png" id="deleteButton'+e+'">'),$("#deleteButton"+e).click(function(){$.post(knownURLS.sheetListURL+"/"+$(this).attr("id").replace(/\D+/g,""),{_method:"DELETE"}),$(this).parentsUntil("tbody").remove()})})}toggleHash.skip=!0}else if(siteIs("pmURL")){var w="#vB_Editor_QR_textarea";$("#vB_Editor_001_textarea").length>0&&(w="#vB_Editor_001_textarea"),$(w).css("height","500px"),addEditorButtons(w.replace(/#/,""),w.replace(/#/,"").split("_").slice(0,-1).join("_")),$("#cb_savecopy").length>0&&toggleHash["Auto-save copy of PMs"]?$("#cb_savecopy").prop("checked",!0):$("#qr_submit").length>0&&toggleHash["Auto-save copy of PMs"]&&$("#qr_submit").before('<input name="savecopy" value="1" id="cb_savecopy" tabindex="1" type="checkbox" checked hidden>')}else log($(location).attr("href").toString()+" is not a known url");if(!toggleHash.skip||!uName){toggleHash["Show online friends"]&&($("#social").html(""),$("#social").attr("style","padding-right:30px"),fillInFriends(),$("#social").fadeIn(1e3)),toggleHash.Widescreen&&widescreen(loadVal("width",90)),toggleHash["Show shop button"]||$("a[href='http://astore.amazon.com/mythweaver-20']").parent().fadeOut(),toggleHash["Show footer"]||$('div[style="text-align: center; padding: 12px;"]').fadeOut().prev().html("<span style='width:100%'></span>"),$(".ad_cs_link").remove(),(showMemStuff||debugMode)&&($("#logo").after(printFauxButton("showMemory",">","List everything the script knows")),$("#headerContainer").after("<fieldset id='MemFieldset' style='float:top;z-index:10' hidden><legend style='color: #ffffcc'>Everything I know</legend><div id='memoryContainer' data-loaded='false'></div></fieldset>"),$("#showMemory").css("color","black").css("float","right").click(function(){if(">"==$("#showMemory").text()){if($("#MemFieldset").slideDown(),$("#showMemory").text("<"),"false"==$("#memoryContainer").attr("data-loaded")){var e=GM_listValues();$("#memoryContainer").append("<ul></ul>");for(var t in e)e[t].endsWith("_type")?$('#memoryContainer > ul > li[data-key="'+e[t].substr(0,e[t].length-5)+'"]').append(" ("+GM_getValue(e[t],"")+")"):($("<li data-key='"+e[t]+"'><a>"+e[t]+"</a></li>").appendTo("#memoryContainer > ul"),$("#memoryContainer > ul > li:last > a").click(function(){if(!$(this).next("div").length){var e=$(this).parent().attr("data-key"),t=loadVal(e,null);$(this).after('<div style="color: #ffffcc" hidden>'+JSON.stringify(t)+"</div>"),$(this).next("div").click(function(){prompt("Are you sure you want to delete "+e+"? (Type something to confirm)")&&(GM_deleteValue(e),GM_deleteValue(e+"_type"),$(this).parent().remove())})}var a=$(this).next("div");a.is(":hidden")?a.slideDown():a.slideUp()}));$("#memoryContainer").attr("data-loaded","true")}}else $("#MemFieldset").slideUp(),$("#showMemory").text(">")})),improveThreads(),refreshStuff(),toggleHash["Replace Site Tools with pop ups"]&&($('#menu_bar a[href="'+knownURLS.pbURL+'"]').attr("href","javascript:;").click(function(){createPBDialog(!1)}),$('#menu_bar a[href="'+knownURLS.npcgenURL+'"]').attr("href","javascript:;").click(createNPCGenDialog),$('#menu_bar a[href="'+knownURLS.lootgenURL+'"]').attr("href","javascript:;").click(createLootGenDialog),$("#menu_bar li:nth-child(3) ul").css("background-size","cover").append("<li><a href='javascript:void' id='pfWepCreator'>PF Weapon Creator</a></li>"),$("#pfWepCreator").click(createWeaponCreatorDialog)),toggleHash["Show search box"]||$("#searchform").remove(),scrollPosHash=loadVal("scrollPosHash",{});var k=document.URL.split("#")[0].replace(/[^\da-z]/gi,"");scrollPosHash[k]&&$(window).scrollTop(scrollPosHash[k]),$(window).click(function(){scrollPosHash[document.URL.split("#")[0].replace(/[^\da-z]/gi,"")]=$(window).scrollTop(),saveVal("scrollPosHash",scrollPosHash)}),dejumpifyLinks()}}}var defaultAttributes=["Fort","Reflex","Will","Init","MBAB","RBAB","CMB","CasterLevel","StrMod","DexMod","ConMod","IntMod","WisMod","ChaMod"],debugMode=!1,showMemStuff=!1,abils=["Str","Dex","Con","Int","Wis","Cha"],props=["Special","AB","Damage","Type","Crit","Range","Ammo"],uNum,uName,sheetHash,myGames,nonBoolSettings,subbedThreads,knownGear,sheetCollectorHash,knownSpells,knownFeats,pinnedThreads,curSheet,curByGame,onlineFriends,curAttributes,imageHash,loadedSheets,subscribedForumLinks,toggleHash,sitewideHash,sitewideCounter,gamewideHash,gamewideCounter,analysisHash,newMessagesLastTime=0,sheetCopyPasteHash,widescreen_firstpass=!0,refreshThisStuff=["#collapseobj_usercp_forums","#notifications","#timenow"],knownURLS={userCPURL:"https://www.myth-weavers.com/usercp.php",pmURL:"https://www.myth-weavers.com/private.php",portalURL:"https://www.myth-weavers.com/",showThreadURL:"https://www.myth-weavers.com/showthread.php",sheetListURL:"https://www.myth-weavers.com/sheets",sheetURL:"https://www.myth-weavers.com/sheet.html#id=",newReplyURL:"https://www.myth-weavers.com/newreply.php",editPostURL:"https://www.myth-weavers.com/editpost.php",forumDisplayURL:"https://www.myth-weavers.com/forumdisplay.php",memberURL:"https://www.myth-weavers.com/member.php",newThreadURL:"https://www.myth-weavers.com/newthread.php",pbURL:"https://www.myth-weavers.com/pointbuy.html",npcgenURL:"https://www.myth-weavers.com/generate_npc.php?",lootgenURL:"https://www.myth-weavers.com/generate_treasure.php?",searchURL:"https://www.myth-weavers.com/search.php"},nonBoolDefaults={"Number of feat columns":{global:16,local:8},"Number of spell sheets":{global:4,local:4},"Number of item backpacks":{global:6,local:4}},toggleDefaults={"Show game-wide templates":!0,"Show site-wide templates":!1,"Rearrange front page":!0,"Auto-load sheet on visit":!1,"Show featstore":!1,"Show spell sheets":!0,"Show item backpacks":!0,"Show feat suggestions":!0,"Show item suggestions":!0,"Show spell suggestions":!0,"Keep time current":!0,"Show online friends":!0,"Audio notify when new messages are received":!1,"Hide signatures":!0,"Add extra buttons to threads":!0,"Show who is browsing subscribed games":!0,"Show dice composer":!0,Widescreen:!1,WidescreenPortal:!0,"Tally gold spent in Currency box":!1,"Show past thread analyses":!1,"Show user analyses in hover":!0,"Auto-analyse thread on thread visit":!1,"Quench auto-crossclassing when skill name changes":!0,"Show shop button":!1,"Show footer":!1,"Show toolkit":!0,"Remind me of unread messages":!1,"Tally gold spent in Currency box":!0,"Auto-save copy of PMs":!0,"Private recipients checked by default":!1,"Show resize controls on front page":!1,"Use weight column for item costs":!1,"Replace Site Tools with pop ups":!0,"Show search box":!1},sheetToggleList=["Use weight column for item costs","Auto-load sheet on visit","Tally gold spent in Currency box","Quench auto-crossclassing when skill name changes","Show featstore","Show spell sheets","Show item backpacks","Show feat suggestions","Show item suggestions","Show spell suggestions"],defaultNewMessageURL="https://hydra-media.cursecdn.com/dota2.gamepedia.com/e/e3/Announcer_intl2012_usher_02.mp3",buffHash={},staticNewMessageImage="//static.myth-weavers.com/images/sonata/statusicon/thread_new.gif",prettyAttributes={Fort:"Fort save",Reflex:"Reflex save",Will:"Will save",Init:"Initiative",MBAB:"Melee attack",RBAB:"Ranged attack",CMB:"Combat Manoeuvre",CasterLevel:"Caster level check",StrMod:"Strength check",DexMod:"Dexterity check",ConMod:"Constitution check",IntMod:"Intelligence check",WisMod:"Wisdom check",ChaMod:"Charisma check"},fauxButton="-moz-appearance: button; max-width: 100px; text-align: center; padding: 1px; cursor:pointer; display:inline-block; ";jQuery.expr[":"].CoNTains=jQuery.expr.createPseudo(function(e){return function(t){return jQuery(t).text().toUpperCase().indexOf(e.toUpperCase())>=0}}),function(e){e.titleAlert=function(t,a){if(e.titleAlert._running&&e.titleAlert.stop(),e.titleAlert._settings=a=e.extend({},e.titleAlert.defaults,a),!a.requireBlur||!e.titleAlert.hasFocus){a.originalTitleInterval=a.originalTitleInterval||a.interval,e.titleAlert._running=!0,e.titleAlert._initialText=document.title,document.title=t;var i=!0,n=function(){e.titleAlert._running&&(i=!i,document.title=i?t:e.titleAlert._initialText,e.titleAlert._intervalToken=setTimeout(n,i?a.interval:a.originalTitleInterval))};e.titleAlert._intervalToken=setTimeout(n,a.interval),a.stopOnMouseMove&&e(document).mousemove(function(t){e(this).unbind(t),e.titleAlert.stop()}),a.duration>0&&(e.titleAlert._timeoutToken=setTimeout(function(){e.titleAlert.stop()},a.duration))}},e.titleAlert.defaults={interval:500,originalTitleInterval:null,duration:0,stopOnFocus:!0,requireBlur:!0,stopOnMouseMove:!1},e.titleAlert.stop=function(){clearTimeout(e.titleAlert._intervalToken),clearTimeout(e.titleAlert._timeoutToken),document.title=e.titleAlert._initialText,e.titleAlert._timeoutToken=null,e.titleAlert._intervalToken=null,e.titleAlert._initialText=null,e.titleAlert._running=!1,e.titleAlert._settings=null},e.titleAlert.hasFocus=!0,e.titleAlert._running=!1,e.titleAlert._intervalToken=null,e.titleAlert._timeoutToken=null,e.titleAlert._initialText=null,e.titleAlert._settings=null,e.titleAlert._focus=function(){if(e.titleAlert.hasFocus=!0,e.titleAlert._running&&e.titleAlert._settings.stopOnFocus){var t=e.titleAlert._initialText;e.titleAlert.stop(),setTimeout(function(){e.titleAlert._running||(document.title=".",document.title=t)},1e3)}},e.titleAlert._blur=function(){e.titleAlert.hasFocus=!1},e(window).bind("focus",e.titleAlert._focus),e(window).bind("blur",e.titleAlert._blur)}(jQuery);